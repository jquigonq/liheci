<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mastering Liheci (ç¦»åˆè¯)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* Palette */
        :root {
            --color-bg: #FDFBF7;
            --color-text: #2C3E50;
            --color-accent: #C0392B;
            --color-highlight: #D4AC0D;
            --color-success: #27AE60;
            --color-ai: #8E44AD;
        }
        <script type="module">
  // IMPORTS FIREBASE
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  // CONFIGURACIÃ“N DE TU APP
  const firebaseConfig = {
    apiKey: "AIzaSyALvmbIb_QTvxf1Zm2Eoxth1QQPkO3vsqU",
    authDomain: "liheci-web.firebaseapp.com",
    projectId: "liheci-web",
    storageBucket: "liheci-web.firebasestorage.app",
    messagingSenderId: "728983905000",
    appId: "1:728983905000:web:460d600284bd2b891adf5d"
  };

  // INICIALIZACIÃ“N
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ============================
  // âœ… LECTURA PÃšBLICA DE VERBOS
  // ============================
  window.loadVerbsFromFirebase = async function () {
    const querySnapshot = await getDocs(collection(db, "verbs"));
    const verbs = [];
    querySnapshot.forEach((doc) => {
      verbs.push({ id: doc.id, ...doc.data() });
    });
    console.log("Verbos cargados desde Firebase:", verbs);
    return verbs;
  };

  // ============================
  // âœ… LOGIN SOLO ADMIN
  // ============================
  window.adminLogin = async function (email, password) {
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      alert("Admin conectado correctamente");
      console.log("Admin UID:", userCredential.user.uid);
    } catch (e) {
      alert("Error de login");
      console.error(e);
    }
  };

  // ============================
  // âœ… DETECTAR SESIÃ“N ACTIVA
  // ============================
  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log("Admin logueado:", user.uid);
    } else {
      console.log("Usuario no autenticado");
    }
  });

</script>


        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: 'Noto Sans SC', sans-serif;
        }

        h1, h2, h3, .chinese-font {
            font-family: 'Noto Serif SC', serif;
        }

        /* Grammar Highlighting */
        .g-verb { color: #2980b9; font-weight: bold; }
        .g-obj { color: #27ae60; font-weight: bold; }
        .g-insert { color: #c0392b; border-bottom: 2px solid #c0392b; }

        /* Card Styles */
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid transparent;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .card.type-core { border-left-color: var(--color-accent); }
        .card.type-phrase { border-left-color: var(--color-highlight); }
        .card.type-missing { border-left-color: var(--color-success); }

        .hanzi-lg { font-size: 1.5rem; font-weight: 700; }
        .pinyin { color: #7F8C8D; font-size: 0.9rem; }

        /* Animation */
        .expand-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .expand-content.active {
            max-height: 1200px;
        }

        /* Analysis Box Styles */
        .analysis-box {
            background-color: #F8FAFC;
            border-left: 3px solid var(--color-ai);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }
        .analysis-section-title {
            font-weight: 700;
            color: #4A5568;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
        }
        .analysis-section-title span { margin-right: 0.5rem; }

        /* Toggle Switch Visuals */
        .toggle-bg { transition: background-color 0.2s ease-in-out; }
        .toggle-dot { transition: transform 0.2s ease-in-out; }
        
        .hidden-content { display: none !important; }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--color-ai);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal.open {
            opacity: 1;
            pointer-events: auto;
        }

        .pattern-box {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            height: 100%;
        }

        .chart-wrapper {
            position: relative;
            height: 250px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        /* TAB NAVIGATION */
        .nav-btn { position: relative; padding-bottom: 4px; }
        .nav-btn.active { color: var(--color-accent); font-weight: 700; }
        .nav-btn.active::after {
            content: ''; position: absolute; bottom: -20px; left: 0; width: 100%; height: 3px; background-color: var(--color-accent);
        }

        .view-section { display: none; opacity: 0; transition: opacity 0.3s ease-in; }
        .view-section.active { display: block; opacity: 1; }
    </style>
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="min-h-screen flex flex-col relative">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-stone-200">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer" onclick="switchTab('theory')">
                <span class="text-2xl text-red-700 font-bold border-2 border-red-700 p-1 rounded">ç¦»åˆ</span>
                <div>
                    <h1 class="text-lg md:text-xl font-bold text-gray-800 leading-tight" data-i18n="app_title">GuÃ­a de Verbos Separables</h1>
                    <p class="text-xs text-gray-500 hidden md:block" data-i18n="app_subtitle">GramÃ¡tica y Vocabulario HSK</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <nav class="hidden md:flex space-x-8 text-sm font-medium text-gray-600 h-full items-center">
                    <button onclick="switchTab('theory')" id="nav-theory" class="nav-btn active transition hover:text-red-700" data-i18n="nav_theory">TeorÃ­a</button>
                    <button onclick="switchTab('vocab')" id="nav-vocab" class="nav-btn transition hover:text-red-700" data-i18n="nav_vocab">Vocabulario</button>
                    <button onclick="switchTab('lab')" id="nav-lab" class="nav-btn transition hover:text-purple-700 text-purple-600 font-bold" data-i18n="nav_lab">Laboratorio IA âœ¨</button>
                </nav>
                <button onclick="toggleSettings()" class="text-gray-500 hover:text-gray-800 transition p-2 rounded-full hover:bg-gray-100 relative group" title="Configurar / Settings">
                    <span class="text-xl">âš™ï¸</span>
                    <span id="key-status-dot" class="absolute top-2 right-2 w-2 h-2 rounded-full bg-red-500 ring-2 ring-white"></span>
                </button>
            </div>
        </div>
        <!-- Mobile Nav -->
        <div class="md:hidden flex justify-around border-t border-gray-100 bg-white py-2 text-xs font-medium text-gray-600">
            <button onclick="switchTab('theory')" class="mobile-nav-btn p-2" id="mob-theory">TeorÃ­a</button>
            <button onclick="switchTab('vocab')" class="mobile-nav-btn p-2" id="mob-vocab">Lista</button>
            <button onclick="switchTab('lab')" class="mobile-nav-btn p-2 text-purple-600" id="mob-lab">IA âœ¨</button>
        </div>
    </header>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 relative transform transition-all scale-95" id="modal-content">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">âœ•</button>
            <h3 class="text-xl font-bold text-gray-800 mb-2" data-i18n="modal_title">ConfiguraciÃ³n</h3>
            <div class="mb-6 border-b border-gray-100 pb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2" data-i18n="modal_lang_label">Idioma / Language</label>
                <div class="flex space-x-2">
                    <button onclick="changeLanguage('es')" id="lang-btn-es" class="flex-1 py-2 px-4 rounded border text-sm font-medium transition hover:bg-gray-50">EspaÃ±ol ğŸ‡ªğŸ‡¸</button>
                    <button onclick="changeLanguage('en')" id="lang-btn-en" class="flex-1 py-2 px-4 rounded border text-sm font-medium transition hover:bg-gray-50">English ğŸ‡ºğŸ‡¸</button>
                </div>
            </div>
            <p class="text-sm text-gray-600 mb-4" data-i18n="modal_desc">Para usar las funciones de IA, necesitas una API Key.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Gemini API Key</label>
                    <input type="password" id="api-key-input" class="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition" placeholder="Paste your key (AIza...)">
                    <p class="text-xs text-gray-400 mt-1" data-i18n="modal_privacy">Tu clave se guarda localmente en tu navegador.</p>
                </div>
                <div class="flex justify-between items-center pt-2">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-purple-600 hover:underline font-medium" data-i18n="modal_get_key">Obtener clave gratis â†—</a>
                    <button onclick="saveSettings()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded shadow transition" data-i18n="modal_save">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Wrapper -->
    <main class="flex-grow flex flex-col relative min-h-[calc(100vh-80px)]">

        <!-- THEORY TAB -->
        <section id="view-theory" class="view-section active bg-[#FDFBF7] py-10 md:py-16 fade-in">
            <div class="container mx-auto px-4 max-w-5xl space-y-12">
                <div class="text-center space-y-4">
                    <span class="text-sm font-bold tracking-widest text-red-600 uppercase" data-i18n="hero_tag">GRAMÃTICA HSK</span>
                    <h2 class="text-3xl md:text-5xl font-bold text-gray-800" data-i18n="theory_title">GramÃ¡tica de los ç¦»åˆè¯</h2>
                    <p class="text-gray-600 leading-relaxed text-lg max-w-2xl mx-auto" data-i18n="theory_intro">
                        Los <strong>ç¦»åˆè¯ (LÃ­hÃ©cÃ­)</strong>, o verbos separables, son compuestos lÃ©xicos con una estructura interna de <strong>Verbo + Objeto</strong>. Aunque semÃ¡nticamente expresan un concepto Ãºnico (como 'Dormir' o 'Nadar'), sintÃ¡cticamente se comportan como una frase flexible. Esto permite que elementos gramaticales (como duraciÃ³n o partÃ­culas) se inserten <strong>entre</strong> el verbo y el objeto, en lugar de ir al final.
                    </p>
                </div>
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="pattern-box border-t-4 border-blue-500 shadow-sm">
                        <div class="text-4xl mb-4 text-center">ğŸ¥ª</div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2 text-center" data-i18n="rule1_title">Estructura SÃ¡ndwich</h3>
                        <p class="text-sm text-gray-600 mb-4 text-center leading-relaxed" data-i18n="rule1_desc">El compuesto se separa temporalmente para intercalar informaciÃ³n gramatical (duraciÃ³n, partÃ­culas) en su interior.</p>
                        <div class="bg-stone-50 p-3 rounded text-center font-serif text-lg">
                            <span class="g-verb" data-i18n="gram_verb">Verbo</span> + <span class="g-insert" data-i18n="gram_info">Info</span> + <span class="g-obj" data-i18n="gram_obj">Objeto</span>
                        </div>
                    </div>
                    <div class="pattern-box border-t-4 border-red-500 shadow-sm">
                        <div class="text-4xl mb-4 text-center">â›”</div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2 text-center" data-i18n="rule2_title">Regla de Oro</h3>
                        <p class="text-sm text-gray-600 mb-4 text-center leading-relaxed" data-i18n="rule2_desc">No puedes aÃ±adir otro objeto al final, Â¡ya tiene uno!</p>
                        <div class="bg-red-50 p-2 rounded text-xs text-center text-red-800 mb-1">
                            âŒ æˆ‘<span class="g-verb">è§</span><span class="g-obj">é¢</span> <span class="underline" data-i18n="gram_you">ä½ </span>
                        </div>
                        <div class="bg-green-50 p-2 rounded text-xs text-center text-green-800">
                            âœ… æˆ‘è·Ÿ<span class="underline" data-i18n="gram_you">ä½ </span> <span class="g-verb">è§</span><span class="g-obj">é¢</span>
                        </div>
                    </div>
                    <div class="pattern-box border-t-4 border-yellow-500 shadow-sm">
                        <div class="text-4xl mb-4 text-center">ğŸ’¡</div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2 text-center" data-i18n="rule3_title">V+O vs Separable Puro</h3>
                        <p class="text-sm text-gray-600 text-center leading-relaxed" data-i18n="rule3_desc">
                            <strong>Comprar coche (ä¹°è½¦)</strong> es literal.<br><strong>Nadar (æ¸¸æ³³)</strong> es abstracto.
                        </p>
                    </div>
                </div>
                <div class="text-center pt-8">
                    <button onclick="switchTab('vocab')" class="bg-red-700 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-red-800 transition transform hover:scale-105" data-i18n="btn_goto_vocab">Ir al Vocabulario âœ</button>
                </div>
            </div>
        </section>

        <!-- VOCAB TAB -->
        <section id="view-vocab" class="view-section bg-gray-100 py-10 md:py-16 min-h-screen">
            <div class="container mx-auto px-4 max-w-5xl space-y-6">
                
                <!-- SUMMARY CHART SECTION -->
                <div class="bg-white rounded-xl shadow-sm p-6 border border-stone-100 flex flex-col md:flex-row items-center gap-8 mb-8">
                    <div class="md:w-1/2 space-y-4">
                        <h2 class="text-2xl font-bold text-gray-800" data-i18n="stats_title">Resumen de la ColecciÃ³n</h2>
                        <p class="text-gray-600 leading-relaxed text-sm">
                            <span data-i18n="stats_text_1">La base de datos contiene</span> 
                            <strong class="text-red-700 text-lg" id="total-verbs-count">0</strong> 
                            <span data-i18n="stats_text_2">verbos. Se clasifican segÃºn su naturaleza gramatical:</span>
                        </p>
                        <ul class="space-y-2 text-sm text-gray-600">
                            <li class="flex items-center"><span class="w-3 h-3 rounded-full bg-red-600 mr-2"></span> <span data-i18n="stats_legend_1">Separables Puros (Abstractos)</span></li>
                            <li class="flex items-center"><span class="w-3 h-3 rounded-full bg-yellow-400 mr-2"></span> <span data-i18n="stats_legend_2">Frases Verbo-Objeto (Literales)</span></li>
                            <li class="flex items-center"><span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span> <span data-i18n="stats_legend_3">AÃ±adidos (Esenciales HSK)</span></li>
                        </ul>
                    </div>
                    <div class="md:w-1/2 w-full flex justify-center">
                        <div class="chart-wrapper">
                            <canvas id="vocabChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row justify-between items-end md:items-center border-b border-gray-300 pb-4 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <span class="mr-2">ğŸ“š</span> <span data-i18n="vocab_title">Biblioteca de Verbos</span>
                    </h2>
                    <div class="text-sm text-gray-500 mt-2 md:mt-0">
                        <span id="filtered-count" class="font-bold text-gray-800">0</span> <span data-i18n="vocab_count_label">palabras mostradas</span>
                    </div>
                </div>

                <!-- CONTROLS & FILTERS -->
                <div class="space-y-6 sticky top-16 z-40 bg-gray-100/95 backdrop-blur py-4 shadow-sm -mx-4 px-4 md:mx-0 md:px-0 rounded-lg border-b border-gray-200">
                    
                    <div class="flex flex-col gap-4">
                        
                        <!-- Row 1: Structural Filters (Type) -->
                        <div class="flex flex-wrap items-center">
                            <span class="text-xs font-bold text-gray-400 uppercase w-20 shrink-0" data-i18n="filter_label_type">Tipo:</span>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="setFilter('type', 'all')" class="filter-type px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition active-filter" data-val="all" data-i18n="filter_all">Todos</button>
                                <button onclick="setFilter('type', 'core')" class="filter-type px-3 py-1 rounded-full text-sm bg-red-100 text-red-800 hover:bg-red-200 transition" data-val="core" data-i18n="filter_core">Separables</button>
                                <button onclick="setFilter('type', 'phrase')" class="filter-type px-3 py-1 rounded-full text-sm bg-yellow-100 text-yellow-800 hover:bg-yellow-200 transition" data-val="phrase" data-i18n="filter_phrase">Frases V+O</button>
                                <button onclick="setFilter('type', 'missing')" class="filter-type px-3 py-1 rounded-full text-sm bg-green-100 text-green-800 hover:bg-green-200 transition" data-val="missing" data-i18n="filter_added">AÃ±adidos</button>
                            </div>
                        </div>

                        <!-- Row 2: Functional Category (NEW) -->
                        <div class="flex flex-wrap items-center">
                            <span class="text-xs font-bold text-gray-400 uppercase w-20 shrink-0" data-i18n="filter_label_cat">CategorÃ­a:</span>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="setFilter('cat', 'all')" class="filter-cat px-3 py-1 rounded-full text-sm bg-gray-800 text-white shadow transition" data-val="all" data-i18n="cat_all">Todas</button>
                                <button onclick="setFilter('cat', 'social')" class="filter-cat px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition" data-val="social" data-i18n="cat_social">ğŸ—£ï¸ Social</button>
                                <button onclick="setFilter('cat', 'motion')" class="filter-cat px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition" data-val="motion" data-i18n="cat_motion">ğŸƒâ€â™‚ï¸ Movimiento</button>
                                <button onclick="setFilter('cat', 'routine')" class="filter-cat px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition" data-val="routine" data-i18n="cat_routine">ğŸ  Rutina</button>
                            </div>
                        </div>

                        <div class="border-t border-gray-200 pt-3 flex flex-col md:flex-row justify-between items-center gap-4">
                            <!-- Row 3: HSK Level (Integrated counts) -->
                            <div class="flex flex-wrap gap-2 items-center">
                                <span class="text-xs font-bold text-gray-400 uppercase mr-1" data-i18n="filter_label_level">Nivel:</span>
                                
                                <button onclick="setFilter('hsk', 'all')" class="filter-hsk px-2 py-1 rounded text-xs border border-gray-300 text-gray-600 hover:bg-white active-hsk bg-gray-800 text-white border-transparent" data-val="all">All</button>
                                
                                <button onclick="setFilter('hsk', 'HSK1')" id="btn-hsk-1" class="filter-hsk px-2 py-1 rounded text-xs border border-gray-300 text-gray-600 hover:bg-white" data-val="HSK1">HSK 1 (0)</button>
                                
                                <button onclick="setFilter('hsk', 'HSK2')" id="btn-hsk-2" class="filter-hsk px-2 py-1 rounded text-xs border border-gray-300 text-gray-600 hover:bg-white" data-val="HSK2">HSK 2 (0)</button>
                                
                                <button onclick="setFilter('hsk', 'HSK3')" id="btn-hsk-3" class="filter-hsk px-2 py-1 rounded text-xs border border-gray-300 text-gray-600 hover:bg-white" data-val="HSK3">HSK 3 (0)</button>
                                
                                <button onclick="setFilter('hsk', 'HSK4')" id="btn-hsk-4" class="filter-hsk px-2 py-1 rounded text-xs border border-gray-300 text-gray-600 hover:bg-white" data-val="HSK4">HSK 4+ (0)</button>
                            </div>

                            <!-- View Toggles -->
                            <div class="flex gap-4 border-l border-gray-300 pl-4">
                                <label class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="toggle-pinyin" class="sr-only toggle-checkbox" checked onchange="toggleView('pinyin')">
                                        <div id="vis-pinyin-bg" class="block bg-green-400 w-10 h-6 rounded-full toggle-bg"></div>
                                        <div id="vis-pinyin-dot" class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full toggle-dot translate-x-full"></div>
                                    </div>
                                    <div class="ml-2 text-xs font-bold text-gray-600 uppercase">Pinyin</div>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="toggle-mean" class="sr-only toggle-checkbox" checked onchange="toggleView('mean')">
                                        <div id="vis-mean-bg" class="block bg-green-400 w-10 h-6 rounded-full toggle-bg"></div>
                                        <div id="vis-mean-dot" class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full toggle-dot translate-x-full"></div>
                                    </div>
                                    <div class="ml-2 text-xs font-bold text-gray-600 uppercase" data-i18n="toggle_mean">Trad.</div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cards Grid -->
                <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pt-2">
                    <!-- Javascript will populate this -->
                </div>
            </div>
        </section>

        <!-- LAB TAB -->
        <section id="view-lab" class="view-section bg-white py-10 md:py-16">
            <div class="container mx-auto px-4 max-w-5xl">
                <div class="bg-white rounded-xl shadow-lg border border-purple-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 text-white">
                        <h3 class="text-2xl font-bold flex items-center">
                            <span class="text-3xl mr-3">ğŸ§ª</span> <span data-i18n="lab_title">Laboratorio de GramÃ¡tica IA</span>
                        </h3>
                        <p class="text-purple-100 text-sm mt-1" data-i18n="lab_subtitle">Escribe una frase y la IA verificarÃ¡ si has separado correctamente el verbo.</p>
                    </div>
                    <div class="p-6 md:p-8 grid md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2" data-i18n="lab_input_label">Tu frase en chino:</label>
                                <textarea id="grammar-input" rows="4" class="w-full p-4 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition bg-gray-50" placeholder="e.g.: æˆ‘ç¡è§‰äº†ä¸‰ä¸ªå°æ—¶ ..."></textarea>
                            </div>
                            <button onclick="checkGrammar()" id="btn-check-grammar" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg shadow transition flex items-center justify-center space-x-2">
                                <span data-i18n="lab_button">Analizar GramÃ¡tica âœ¨</span>
                            </button>
                        </div>
                        <div class="bg-stone-50 rounded-lg p-6 border border-stone-200 relative min-h-[200px]">
                            <h4 class="text-xs uppercase tracking-wide text-gray-500 font-bold mb-3" data-i18n="lab_result_title">DiagnÃ³stico de la IA</h4>
                            <div id="grammar-result" class="text-gray-600 text-sm leading-relaxed">
                                <p class="italic text-gray-400" data-i18n="lab_placeholder">El resultado aparecerÃ¡ aquÃ­...</p>
                            </div>
                            <div id="grammar-loader" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center">
                                <div class="flex flex-col items-center">
                                    <div class="loader mb-2"></div>
                                    <span class="text-xs text-purple-600 font-bold" data-i18n="lab_loading">Analizando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-gray-800 text-gray-400 py-6 text-center text-sm">
        <div class="container mx-auto">
            <p data-i18n="footer">Herramienta educativa para el aprendizaje de chino.</p>
            <p class="mt-2 text-xs opacity-50">Potenciado por Gemini API âœ¨</p>
        </div>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        const translations = {
            es: {
                app_title: "GuÃ­a de Verbos Separables", app_subtitle: "GramÃ¡tica y Vocabulario HSK",
                nav_theory: "TeorÃ­a", nav_vocab: "Vocabulario", nav_lab: "Laboratorio IA âœ¨",
                modal_title: "ConfiguraciÃ³n", modal_lang_label: "Idioma / Language", modal_desc: "Para usar las funciones de IA, necesitas una API Key.",
                modal_privacy: "Tu clave se guarda localmente en tu navegador.", modal_get_key: "Obtener clave gratis â†—", modal_save: "Guardar",
                hero_tag: "GRAMÃTICA HSK", theory_title: "GramÃ¡tica de los ç¦»åˆè¯",
                theory_intro: "Los <strong>ç¦»åˆè¯ (LÃ­hÃ©cÃ­)</strong>, o verbos separables, son compuestos lÃ©xicos con una estructura interna de <strong>Verbo + Objeto</strong>. Aunque semÃ¡nticamente expresan un concepto Ãºnico (como 'Dormir' o 'Nadar'), sintÃ¡cticamente se comportan como una frase flexible. Esto permite que elementos gramaticales (como duraciÃ³n o partÃ­culas) se inserten <strong>entre</strong> el verbo y el objeto, en lugar de ir al final.",
                rule1_title: "Estructura SÃ¡ndwich", rule1_desc: "El compuesto se separa temporalmente para intercalar informaciÃ³n gramatical (duraciÃ³n, partÃ­culas) en su interior.",
                rule2_title: "Regla de Oro", rule2_desc: "No puedes aÃ±adir otro objeto al final, Â¡ya tiene uno!",
                rule3_title: "V+O vs Separable Puro", rule3_desc: "<strong>Comprar coche (ä¹°è½¦)</strong> es literal.<br><strong>Nadar (æ¸¸æ³³)</strong> es abstracto.",
                patterns_title: "3 Patrones Comunes", pat_time: "DuraciÃ³n", pat_quant: "Cantidad", pat_aspect: "Completado",
                ex_time: "Dormir <strong>3 horas</strong>", ex_quant: "BaÃ±arse <strong>una vez</strong>", ex_aspect: "Haberse conocido",
                gram_verb: "Verbo", gram_info: "Info", gram_obj: "Objeto", gram_you: "tÃº",
                btn_goto_vocab: "Ir al Vocabulario âœ", vocab_title: "Biblioteca de Verbos", vocab_count_label: "palabras mostradas",
                
                stats_title: "Resumen de la ColecciÃ³n", stats_text_1: "La base de datos contiene", stats_text_2: "verbos. Se clasifican segÃºn su naturaleza gramatical:",
                stats_legend_1: "Separables Puros (Abstractos)", stats_legend_2: "Frases Verbo-Objeto (Literales)", stats_legend_3: "AÃ±adidos (Esenciales HSK)",
                chart_l1: "Separables Puros", chart_l2: "Frases V+O", chart_l3: "AÃ±adidos",

                filter_label_type: "Tipo:", filter_label_level: "Nivel:", filter_label_cat: "CategorÃ­a:",
                filter_all: "Todos", filter_core: "Separables", filter_phrase: "Frases V+O", filter_added: "AÃ±adidos",
                cat_all: "Todas", cat_social: "ğŸ—£ï¸ Social", cat_motion: "ğŸƒâ€â™‚ï¸ Movimiento", cat_routine: "ğŸ  Rutina",

                toggle_mean: "Trad.", lab_title: "Laboratorio de GramÃ¡tica IA", lab_subtitle: "Escribe una frase y la IA verificarÃ¡ la estructura del verbo separable.",
                lab_input_label: "Tu frase en chino:", lab_button: "Analizar GramÃ¡tica âœ¨", lab_result_title: "DiagnÃ³stico de la IA",
                lab_placeholder: "El resultado aparecerÃ¡ aquÃ­...", lab_loading: "Analizando...", footer: "Herramienta educativa para el aprendizaje de chino.",
                tag_core: "Separable Puro", tag_phrase: "Frase V+O", tag_missing: "AÃ±adido", split_label: "SeparaciÃ³n:",
                gen_btn: "Generar Ejemplo Nuevo âœ¨", gen_loading: "Generando...", card_hint: "ğŸ‘‡ Toca para ver estructura",
                deep_btn: "AnÃ¡lisis Profundo ğŸ§", deep_loading: "Investigando...",
                analysis_comp: "ğŸ§© ComposiciÃ³n y EtimologÃ­a", analysis_syn: "âš ï¸ Sintaxis y Errores", analysis_prag: "ğŸ—£ï¸ Uso y Contexto",
                alert_key: "Por favor, introduce una clave vÃ¡lida.", ai_error: "Error de conexiÃ³n o clave.", prompt_lang_instruction: "in Spanish"
            },
            en: {
                app_title: "Separable Verbs Guide", app_subtitle: "HSK Grammar and Vocabulary",
                nav_theory: "Theory", nav_vocab: "Vocabulary", nav_lab: "AI Lab âœ¨",
                modal_title: "Settings", modal_lang_label: "Language / Idioma", modal_desc: "To use AI features, you need an API Key.",
                modal_privacy: "Your key is stored locally in your browser.", modal_get_key: "Get free key â†—", modal_save: "Save",
                hero_tag: "HSK GRAMMAR", theory_title: "Grammar of ç¦»åˆè¯",
                theory_intro: "**ç¦»åˆè¯ (LÃ­hÃ©cÃ­)**, or separable verbs, are lexical compounds with an internal **Verb + Object** structure. Although semantically they express a single concept (like 'Sleep' or 'Swim'), syntactically they behave as a flexible phrase. This allows grammatical elements (such as duration or particles) to be inserted **between** the verb and the object, rather than appearing at the end.",
                rule1_title: "Sandwich Structure", rule1_desc: "The compound splits temporarily to insert grammatical information (duration, particles) inside.",
                rule2_title: "Golden Rule", rule2_desc: "You cannot place another object at the end, it already has one!",
                rule3_title: "VO vs Pure Separable", rule3_desc: "<strong>Buy car (ä¹°è½¦)</strong> is literal.<br><strong>Swim (æ¸¸æ³³)</strong> is abstract.",
                patterns_title: "3 Common Patterns", pat_time: "Duration", pat_quant: "Quantity", pat_aspect: "Completed",
                ex_time: "Sleep for <strong>3 hours</strong>", ex_quant: "Take a bath <strong>once</strong>", ex_aspect: "Have met before",
                gram_verb: "Verb", gram_info: "Info", gram_obj: "Object", gram_you: "you",
                btn_goto_vocab: "Go to Vocabulary âœ", vocab_title: "Verb Library", vocab_count_label: "words shown",
                
                stats_title: "Collection Summary", stats_text_1: "The database contains", stats_text_2: "verbs. Classified by grammatical nature:",
                stats_legend_1: "True Separables (Abstract)", stats_legend_2: "VO Phrases (Literal)", stats_legend_3: "Added (HSK Essentials)",
                chart_l1: "True Separables", chart_l2: "VO Phrases", chart_l3: "Added",

                filter_label_type: "Type:", filter_label_level: "Level:", filter_label_cat: "Category:",
                filter_all: "All", filter_core: "True Separable", filter_phrase: "VO Phrase", filter_added: "Added",
                cat_all: "All", cat_social: "ğŸ—£ï¸ Social", cat_motion: "ğŸƒâ€â™‚ï¸ Motion", cat_routine: "ğŸ  Routine",

                toggle_mean: "Trans.", lab_title: "AI Grammar Lab", lab_subtitle: "Type a sentence and AI will verify the separable verb structure.",
                lab_input_label: "Your Chinese sentence:", lab_button: "Analyze Grammar âœ¨", lab_result_title: "AI Diagnosis",
                lab_placeholder: "Result will appear here...", lab_loading: "Analyzing...", footer: "Educational tool for Chinese learning.",
                tag_core: "True Separable", tag_phrase: "VO Phrase", tag_missing: "Added", split_label: "Split:",
                gen_btn: "Generate New Example âœ¨", gen_loading: "Generating...", card_hint: "ğŸ‘‡ Tap to view structure",
                deep_btn: "Deep Analysis ğŸ§", deep_loading: "Researching...",
                analysis_comp: "ğŸ§© Composition & Etymology", analysis_syn: "âš ï¸ Syntax & Pitfalls", analysis_prag: "ğŸ—£ï¸ Usage & Context",
                alert_key: "Please enter a valid key.", ai_error: "Connection or Key error.", prompt_lang_instruction: "in English"
            }
        };

        let currentLang = 'es';
        let userApiKey = "";
        let currentTab = 'theory';
        let filters = { type: 'all', hsk: 'all', cat: 'all' };
        let viewState = { pinyin: true, mean: true };
        let myChart = null;

        const verbs = [
            { id: 1, hanzi: "è·‘æ­¥", pinyin: "pÇo bÃ¹", type: "core", level: "HSK2", cat: "motion", mean: "Correr", mean_en: "Run / Jog", example: "è·‘äº†äºŒååˆ†é’Ÿæ­¥", ex_pin: "PÇo le Ã¨rshÃ­ fÄ“nzhÅng bÃ¹", ex_mean: "CorrÃ­ durante 20 minutos", ex_mean_en: "Ran for 20 minutes" },
            { id: 2, hanzi: "æ•£æ­¥", pinyin: "sÃ n bÃ¹", type: "core", level: "HSK4", cat: "motion", mean: "Dar un paseo", mean_en: "Take a walk", example: "æ•£äº†ä¸€ä¼šå„¿æ­¥", ex_pin: "SÃ n le yÄ«huÃ¬r bÃ¹", ex_mean: "Di un paseo por un rato", ex_mean_en: "Took a walk for a while" },
            { id: 3, hanzi: "æ¸¸æ³³", pinyin: "yÃ³u yÇ’ng", type: "core", level: "HSK2", cat: "motion", mean: "Nadar", mean_en: "Swim", example: "æ¸¸è¿‡ä¸€æ¬¡æ³³", ex_pin: "YÃ³u guÃ² yÄ« cÃ¬ yÇ’ng", ex_mean: "He nadado una vez", ex_mean_en: "Swam once" },
            { id: 4, hanzi: "è¸¢è¶³çƒ", pinyin: "tÄ« zÃºqiÃº", type: "phrase", level: "HSK2", cat: "motion", mean: "Jugar fÃºtbol", mean_en: "Play soccer", example: "è¸¢äº†ä¸€åœºè¶³çƒ", ex_pin: "TÄ« le yÄ« chÇng zÃºqiÃº", ex_mean: "JuguÃ© un partido de fÃºtbol", ex_mean_en: "Played a soccer match" },
            { id: 5, hanzi: "æ‰“ç¯®çƒ", pinyin: "dÇ lÃ¡nqiÃº", type: "phrase", level: "HSK2", cat: "motion", mean: "Jugar baloncesto", mean_en: "Play basketball", example: "æ‰“è¿‡ç¯®çƒå—ï¼Ÿ", ex_pin: "DÇ guÃ² lÃ¡nqiÃº ma?", ex_mean: "Â¿Has jugado baloncesto alguna vez?", ex_mean_en: "Have you played basketball?" },
            { id: 6, hanzi: "æ‰“æ©„æ¦„çƒ", pinyin: "dÇ gÇnlÇnqiÃº", type: "phrase", level: "HSK5", cat: "motion", mean: "Jugar rugby", mean_en: "Play rugby", example: "æ‰“æ‰“æ©„æ¦„çƒ", ex_pin: "DÇ dÇ gÇnlÇnqiÃº", ex_mean: "Jugar un poco de rugby", ex_mean_en: "Play a bit of rugby" }, 
            { id: 7, hanzi: "æ‰“è½¦", pinyin: "dÇ chÄ“", type: "core", level: "HSK4", cat: "motion", mean: "Tomar taxi", mean_en: "Take a taxi", example: "æ‰“ä¸åˆ°è½¦", ex_pin: "DÇ bÃ¹ dÃ o chÄ“", ex_mean: "No consigo taxi", ex_mean_en: "Cannot get a taxi" },
            { id: 8, hanzi: "éª‘è½¦", pinyin: "qÃ­ chÄ“", type: "phrase", level: "HSK2", cat: "motion", mean: "Montar bici", mean_en: "Ride a bike", example: "éª‘ç€è½¦å»", ex_pin: "QÃ­ zhe chÄ“ qÃ¹", ex_mean: "Ir en bicicleta", ex_mean_en: "Ride a bike there" },
            // PAGE 2
            { id: 9, hanzi: "åœè½¦", pinyin: "tÃ­ng chÄ“", type: "phrase", level: "HSK4", cat: "motion", mean: "Aparcar", mean_en: "Park a car", example: "åœå¥½è½¦", ex_pin: "TÃ­ng hÇo chÄ“", ex_mean: "Aparcar bien el coche", ex_mean_en: "Parked the car well" },
            { id: 10, hanzi: "ä¹°è½¦", pinyin: "mÇi chÄ“", type: "phrase", level: "HSK1", cat: "routine", mean: "Comprar coche", mean_en: "Buy a car", example: "ä¹°äº†ä¸‰è¾†è½¦", ex_pin: "MÇi le sÄn liÃ ng chÄ“", ex_mean: "ComprÃ© tres coches", ex_mean_en: "Bought three cars" },
            { id: 11, hanzi: "å”±æ­Œ", pinyin: "chÃ ng gÄ“", type: "core", level: "HSK2", cat: "motion", mean: "Cantar", mean_en: "Sing", example: "å”±ä¸€é¦–æ­Œ", ex_pin: "ChÃ ng yÄ« shÇ’u gÄ“", ex_mean: "Cantar una canciÃ³n", ex_mean_en: "Sing a song" },
            { id: 12, hanzi: "è·³èˆ", pinyin: "tiÃ o wÇ”", type: "core", level: "HSK2", cat: "motion", mean: "Bailar", mean_en: "Dance", example: "è·³è·³èˆ", ex_pin: "TiÃ o tiÃ o wÇ”", ex_mean: "Bailar un poco", ex_mean_en: "Dance a bit" },
            { id: 13, hanzi: "çœ‹ä¹¦", pinyin: "kÃ n shÅ«", type: "phrase", level: "HSK1", cat: "routine", mean: "Leer", mean_en: "Read a book", example: "çœ‹äº†åŠå¤©ä¹¦", ex_pin: "KÃ n le bÃ ntiÄn shÅ«", ex_mean: "LeÃ­ durante mucho rato", ex_mean_en: "Read for a long time" },
            { id: 14, hanzi: "çœ‹ç”µå½±", pinyin: "kÃ n diÃ nyÇng", type: "phrase", level: "HSK1", cat: "routine", mean: "Ver pelÃ­cula", mean_en: "Watch movie", example: "çœ‹ä¸€åœºç”µå½±", ex_pin: "KÃ n yÄ« chÇng diÃ nyÇng", ex_mean: "Ver una pelÃ­cula", ex_mean_en: "Watch a movie" },
            { id: 15, hanzi: "æ‹ç…§", pinyin: "pÄi zhÃ o", type: "core", level: "HSK3", cat: "motion", mean: "Tomar fotos", mean_en: "Take photos", example: "æ‹ä¸¤å¼ ç…§", ex_pin: "PÄi liÇng zhÄng zhÃ o", ex_mean: "Tomar dos fotos", ex_mean_en: "Take two photos" },
            { id: 16, hanzi: "èµ·åºŠ", pinyin: "qÇ chuÃ¡ng", type: "core", level: "HSK2", cat: "routine", mean: "Levantarse", mean_en: "Get up", example: "èµ·å¾—æ¥åºŠ", ex_pin: "QÇ de lÃ¡i chuÃ¡ng", ex_mean: "Poder levantarse de la cama", ex_mean_en: "Can get out of bed" },
            // PAGE 3
            { id: 17, hanzi: "åˆ·ç‰™", pinyin: "shuÄ yÃ¡", type: "core", level: "HSK3", cat: "routine", mean: "Cepillar dientes", mean_en: "Brush teeth", example: "åˆ·å®Œç‰™", ex_pin: "ShuÄ wÃ¡n yÃ¡", ex_mean: "Terminar de cepillarse", ex_mean_en: "Finish brushing teeth" },
            { id: 18, hanzi: "æ´—è„¸", pinyin: "xÇ liÇn", type: "phrase", level: "HSK3", cat: "routine", mean: "Lavar cara", mean_en: "Wash face", example: "æ´—æ´—è„¸", ex_pin: "XÇ xi liÇn", ex_mean: "Lavarse la cara un poco", ex_mean_en: "Wash face a bit" },
            { id: 19, hanzi: "æ´—æ¾¡", pinyin: "xÇ zÇo", type: "core", level: "HSK3", cat: "routine", mean: "BaÃ±arse", mean_en: "Take a bath", example: "æ´—äº†ä¸€ä¸ªçƒ­æ°´æ¾¡", ex_pin: "XÇ le yÄ« gÃ¨ rÃ¨shuÇ zÇo", ex_mean: "Darse un baÃ±o de agua caliente", ex_mean_en: "Took a hot bath" },
            { id: 20, hanzi: "ç¡è§‰", pinyin: "shuÃ¬ jiÃ o", type: "core", level: "HSK1", cat: "routine", mean: "Dormir", mean_en: "Sleep", example: "ç¡ä¸ªå¥½è§‰", ex_pin: "ShuÃ¬ gÃ¨ hÇo jiÃ o", ex_mean: "Dormir bien", ex_mean_en: "Have a good sleep" },
            { id: 21, hanzi: "åŒ–å¦†", pinyin: "huÃ  zhuÄng", type: "core", level: "HSK4", cat: "routine", mean: "Maquillarse", mean_en: "Put on makeup", example: "åŒ–äº†æµ“å¦†", ex_pin: "HuÃ  le nÃ³ng zhuÄng", ex_mean: "Maquillarse mucho", ex_mean_en: "Put on heavy makeup" },
            { id: 22, hanzi: "ç”Ÿç—…", pinyin: "shÄ“ng bÃ¬ng", type: "core", level: "HSK2", cat: "routine", mean: "Enfermarse", mean_en: "Get sick", example: "ç”Ÿäº†ä¸€åœºå¤§ç—…", ex_pin: "ShÄ“ng le yÄ« chÇng dÃ  bÃ¬ng", ex_mean: "Enfermarse gravemente", ex_mean_en: "Got seriously ill" },
            { id: 23, hanzi: "çœ‹ç—…", pinyin: "kÃ n bÃ¬ng", type: "phrase", level: "HSK1", cat: "routine", mean: "Ver al mÃ©dico", mean_en: "See a doctor", example: "çœ‹äº†ä¸€æ¬¡ç—…", ex_pin: "KÃ n le yÄ« cÃ¬ bÃ¬ng", ex_mean: "Fui al mÃ©dico una vez", ex_mean_en: "Went to see the doctor once" },
            { id: 24, hanzi: "æŠ½çƒŸ", pinyin: "chÅu yÄn", type: "phrase", level: "HSK3", cat: "routine", mean: "Fumar", mean_en: "Smoke", example: "æŠ½äº†ä¸€æ”¯çƒŸ", ex_pin: "ChÅu le yÄ« zhÄ« yÄn", ex_mean: "FumÃ³ un cigarrillo", ex_mean_en: "Smoked a cigarette" },
            // PAGE 4
            { id: 25, hanzi: "å–é…’", pinyin: "hÄ“ jiÇ”", type: "phrase", level: "HSK2", cat: "routine", mean: "Beber alcohol", mean_en: "Drink alcohol", example: "å–ç‚¹é…’", ex_pin: "HÄ“ diÇn jiÇ”", ex_mean: "Beber un poco de alcohol", ex_mean_en: "Drink a little alcohol" },
            { id: 26, hanzi: "æ‰“æ¶", pinyin: "dÇ jiÃ ", type: "core", level: "HSK4", cat: "social", mean: "Pelearse", mean_en: "Fight", example: "æ‰“äº†ä¸€æ¶", ex_pin: "DÇ le yÄ« jiÃ ", ex_mean: "Se pelearon", ex_mean_en: "Had a fight" },
            { id: 27, hanzi: "åµæ¶", pinyin: "chÇo jiÃ ", type: "core", level: "HSK4", cat: "social", mean: "Discutir", mean_en: "Quarrel", example: "è·Ÿæœ‹å‹åµæ¶", ex_pin: "GÄ“n pÃ©ngyÇ’u chÇo jiÃ ", ex_mean: "Discutir con un amigo", ex_mean_en: "Argue with a friend" },
            { id: 28, hanzi: "èŠå¤©", pinyin: "liÃ¡o tiÄn", type: "core", level: "HSK3", cat: "social", mean: "Charlar", mean_en: "Chat", example: "èŠäº†ä¸€ä¼šå„¿å¤©", ex_pin: "LiÃ¡o le yÄ«huÃ¬r tiÄn", ex_mean: "Charlar un rato", ex_mean_en: "Chatted for a while" },
            { id: 29, hanzi: "è¯´è¯", pinyin: "shuÅ huÃ ", type: "phrase", level: "HSK1", cat: "social", mean: "Hablar", mean_en: "Speak", example: "è¯´å¥å¥½è¯", ex_pin: "ShuÅ jÃ¹ hÇo huÃ ", ex_mean: "Decir algo bueno", ex_mean_en: "Say a good word" },
            { id: 30, hanzi: "åšé¥­", pinyin: "zuÃ² fÃ n", type: "phrase", level: "HSK1", cat: "routine", mean: "Cocinar", mean_en: "Cook", example: "åšå®Œé¥­äº†", ex_pin: "ZuÃ² wÃ¡n fÃ n le", ex_mean: "TerminÃ© de cocinar", ex_mean_en: "Finished cooking" },
            { id: 31, hanzi: "åƒé¥­", pinyin: "chÄ« fÃ n", type: "phrase", level: "HSK1", cat: "routine", mean: "Comer", mean_en: "Eat", example: "åƒè¿‡é¥­äº†å—ï¼Ÿ", ex_pin: "ChÄ« guÃ² fÃ n le ma?", ex_mean: "Â¿Ya has comido?", ex_mean_en: "Have you eaten yet?" },
            { id: 32, hanzi: "åƒè¯", pinyin: "chÄ« yÃ o", type: "phrase", level: "HSK2", cat: "routine", mean: "Tomar medicina", mean_en: "Take medicine", example: "åƒç‚¹è¯", ex_pin: "ChÄ« diÇn yÃ o", ex_mean: "Toma un poco de medicina", ex_mean_en: "Take some medicine" },
            // PAGE 5
            { id: 33, hanzi: "æ³¡èŒ¶", pinyin: "pÃ o chÃ¡", type: "phrase", level: "HSK3", cat: "routine", mean: "Hacer tÃ©", mean_en: "Make tea", example: "æ³¡ä¸€å£¶èŒ¶", ex_pin: "PÃ o yÄ« hÃº chÃ¡", ex_mean: "Hacer una tetera de tÃ©", ex_mean_en: "Make a pot of tea" },
            { id: 34, hanzi: "æ´—ç¢—", pinyin: "xÇ wÇn", type: "phrase", level: "HSK2", cat: "routine", mean: "Lavar platos", mean_en: "Wash dishes", example: "æ´—å®Œç¢—", ex_pin: "XÇ wÃ¡n wÇn", ex_mean: "Terminar de lavar los platos", ex_mean_en: "Finish washing dishes" },
            { id: 35, hanzi: "æ‰«åœ°", pinyin: "sÇo dÃ¬", type: "phrase", level: "HSK3", cat: "routine", mean: "Barrer", mean_en: "Sweep floor", example: "æ‰«æ‰«åœ°", ex_pin: "SÇo sÇo dÃ¬", ex_mean: "Barrer un poco el suelo", ex_mean_en: "Sweep the floor a bit" },
            { id: 36, hanzi: "é€›è¡—", pinyin: "guÃ ng jiÄ“", type: "core", level: "HSK3", cat: "motion", mean: "Ir de compras", mean_en: "Go shopping", example: "é€›äº†ä¸€æ•´å¤©è¡—", ex_pin: "GuÃ ng le yÄ« zhÄ›ng tiÄn jiÄ“", ex_mean: "Pasear/comprar todo el dÃ­a", ex_mean_en: "Went shopping all day" },
            { id: 37, hanzi: "æ’é˜Ÿ", pinyin: "pÃ¡i duÃ¬", type: "core", level: "HSK3", cat: "routine", mean: "Hacer cola", mean_en: "Queue up", example: "æ’å¾ˆé•¿çš„é˜Ÿ", ex_pin: "PÃ¡i hÄ›n chÃ¡ng de duÃ¬", ex_mean: "Hacer una cola muy larga", ex_mean_en: "Wait in a long queue" },
            { id: 38, hanzi: "å¼€ä¼š", pinyin: "kÄi huÃ¬", type: "phrase", level: "HSK2", cat: "social", mean: "Tener reuniÃ³n", mean_en: "Have meeting", example: "å¼€å®Œä¼š", ex_pin: "KÄi wÃ¡n huÃ¬", ex_mean: "Terminar la reuniÃ³n", ex_mean_en: "Finish the meeting" },
            { id: 39, hanzi: "å¼€é—¨", pinyin: "kÄi mÃ©n", type: "phrase", level: "HSK1", cat: "motion", mean: "Abrir puerta", mean_en: "Open door", example: "å¼€ä¸€ä¸‹é—¨", ex_pin: "KÄi yÄ«xiÃ  mÃ©n", ex_mean: "Abre la puerta un momento", ex_mean_en: "Open the door for a sec" },
            { id: 40, hanzi: "å…³é—¨", pinyin: "guÄn mÃ©n", type: "phrase", level: "HSK1", cat: "motion", mean: "Cerrar puerta", mean_en: "Close door", example: "å…³å¥½é—¨", ex_pin: "GuÄn hÇo mÃ©n", ex_mean: "Cierra bien la puerta", ex_mean_en: "Close the door properly" },
            // PAGE 6
            { id: 41, hanzi: "ä¸Šç­", pinyin: "shÃ ng bÄn", type: "core", level: "HSK2", cat: "routine", mean: "Ir al trabajo", mean_en: "Go to work", example: "ä¸Šè¿‡ç­", ex_pin: "ShÃ ng guÃ² bÄn", ex_mean: "Haber ido a trabajar", ex_mean_en: "Have gone to work" },
            { id: 42, hanzi: "ä¸Šè¯¾", pinyin: "shÃ ng kÃ¨", type: "phrase", level: "HSK1", cat: "routine", mean: "Ir a clase", mean_en: "Attend class", example: "ä¸Šäº†ä¸¤èŠ‚è¯¾", ex_pin: "ShÃ ng le liÇng jiÃ© kÃ¨", ex_mean: "AsistÃ­ a dos clases", ex_mean_en: "Attended two classes" },
            { id: 43, hanzi: "è¯·å‡", pinyin: "qÇng jiÃ ", type: "core", level: "HSK3", cat: "routine", mean: "Pedir permiso", mean_en: "Ask for leave", example: "è¯·ä¸‰å¤©å‡", ex_pin: "QÇng sÄn tiÄn jiÃ ", ex_mean: "Pedir 3 dÃ­as libres", ex_mean_en: "Ask for 3 days leave" },
            { id: 44, hanzi: "è¯·å®¢", pinyin: "qÇng kÃ¨", type: "core", level: "HSK4", cat: "social", mean: "Invitar", mean_en: "Treat guests", example: "è¯·å¤§å®¶çš„å®¢", ex_pin: "QÇng dÃ jiÄ de kÃ¨", ex_mean: "Invitar a todo el mundo", ex_mean_en: "Treat everyone" },
            { id: 45, hanzi: "ä»˜é’±", pinyin: "fÃ¹ qiÃ¡n", type: "phrase", level: "HSK2", cat: "routine", mean: "Pagar", mean_en: "Pay money", example: "ä»˜è¿‡é’±äº†", ex_pin: "FÃ¹ guÃ² qiÃ¡n le", ex_mean: "Ya he pagado", ex_mean_en: "Already paid" },
            { id: 46, hanzi: "å–é’±", pinyin: "qÇ” qiÃ¡n", type: "phrase", level: "HSK3", cat: "routine", mean: "Sacar dinero", mean_en: "Withdraw money", example: "å–ç‚¹é’±", ex_pin: "QÇ” diÇn qiÃ¡n", ex_mean: "Sacar algo de dinero", ex_mean_en: "Withdraw some money" },
            { id: 47, hanzi: "å­˜é’±", pinyin: "cÃºn qiÃ¡n", type: "phrase", level: "HSK3", cat: "routine", mean: "Ahorrar/Ingresar", mean_en: "Save/Deposit", example: "å­˜äº†ä¸å°‘é’±", ex_pin: "CÃºn le bÃ¹ shÇo qiÃ¡n", ex_mean: "He ahorrado bastante dinero", ex_mean_en: "Saved quite a bit of money" },
            { id: 48, hanzi: "è§é¢", pinyin: "jiÃ n miÃ n", type: "core", level: "HSK3", cat: "social", mean: "Encontrarse", mean_en: "Meet", example: "è·Ÿæœ‹å‹è§ä¸ªé¢", ex_pin: "GÄ“n pÃ©ngyÇ’u jiÃ n gÃ¨ miÃ n", ex_mean: "Encontrarse con un amigo", ex_mean_en: "Meet with a friend" },
            // PAGE 7
            { id: 49, hanzi: "æ¬å®¶", pinyin: "bÄn jiÄ", type: "core", level: "HSK3", cat: "routine", mean: "Mudarse", mean_en: "Move house", example: "æ¬è¿‡ä¸€æ¬¡å®¶", ex_pin: "BÄn guÃ² yÄ« cÃ¬ jiÄ", ex_mean: "Me he mudado una vez", ex_mean_en: "Moved house once" },
            { id: 50, hanzi: "å¸®å¿™", pinyin: "bÄng mÃ¡ng", type: "core", level: "HSK3", cat: "social", mean: "Ayudar", mean_en: "Help", example: "å¸®äº†ä¸€ä¸ªå¤§å¿™", ex_pin: "BÄng le yÄ« gÃ¨ dÃ  mÃ¡ng", ex_mean: "Hizo un gran favor", ex_mean_en: "Did a big favor" },
            { id: 51, hanzi: "ç»“å©š", pinyin: "jiÃ© hÅ«n", type: "core", level: "HSK3", cat: "social", mean: "Casarse", mean_en: "Get married", example: "ç»“è¿‡ä¸¤æ¬¡å©š", ex_pin: "JiÃ© guÃ² liÇng cÃ¬ hÅ«n", ex_mean: "Casarse dos veces", ex_mean_en: "Married twice" },
            { id: 52, hanzi: "ç¦»å©š", pinyin: "lÃ­ hÅ«n", type: "core", level: "HSK4", cat: "social", mean: "Divorciarse", mean_en: "Divorce", example: "ç¦»è¿‡å©š", ex_pin: "LÃ­ guÃ² hÅ«n", ex_mean: "Estar divorciado", ex_mean_en: "Divorced" },
            { id: 53, hanzi: "åˆ†æ‰‹", pinyin: "fÄ“n shÇ’u", type: "core", level: "HSK4", cat: "social", mean: "Romper (relaciÃ³n)", mean_en: "Break up", example: "è·Ÿå¥³æœ‹å‹åˆ†äº†æ‰‹", ex_pin: "GÄ“n nÇšpÃ©ngyÇ’u fÄ“n le shÇ’u", ex_mean: "RompiÃ³ con su novia", ex_mean_en: "Broke up with girlfriend" },
            { id: 54, hanzi: "åˆ®é£", pinyin: "guÄ fÄ“ng", type: "phrase", level: "HSK2", cat: "routine", mean: "Hacer viento", mean_en: "Windy", example: "åˆ®å¤§é£", ex_pin: "GuÄ dÃ  fÄ“ng", ex_mean: "Hace mucho viento", ex_mean_en: "It's very windy" },
            { id: 55, hanzi: "ä¸‹é›¨", pinyin: "xiÃ  yÇ”", type: "phrase", level: "HSK1", cat: "routine", mean: "Llover", mean_en: "Rain", example: "ä¸‹äº†ä¸€åœºé›¨", ex_pin: "XiÃ  le yÄ« chÇng yÇ”", ex_mean: "LloviÃ³ un rato", ex_mean_en: "Rained for a while" },
            { id: 56, hanzi: "ä¸‹é›ª", pinyin: "xiÃ  xuÄ›", type: "phrase", level: "HSK2", cat: "routine", mean: "Nevar", mean_en: "Snow", example: "ä¸‹ç€é›ª", ex_pin: "XiÃ  zhe xuÄ›", ex_mean: "EstÃ¡ nevando", ex_mean_en: "It is snowing" },
            // ADDED
            { id: 57, hanzi: "ç”Ÿæ°”", pinyin: "shÄ“ng qÃ¬", type: "missing", level: "HSK3", cat: "social", mean: "Enfadarse", mean_en: "Get angry", example: "ç”Ÿè¿‡æˆ‘çš„æ°”", ex_pin: "ShÄ“ng guÃ² wÇ’ de qÃ¬", ex_mean: "Se ha enfadado conmigo", ex_mean_en: "Has been angry with me" },
            { id: 58, hanzi: "è€ƒè¯•", pinyin: "kÇo shÃ¬", type: "missing", level: "HSK2", cat: "routine", mean: "Examinarse", mean_en: "Take exam", example: "è€ƒå®Œè¯•äº†", ex_pin: "KÇo wÃ¡n shÃ¬ le", ex_mean: "Examen terminado", ex_mean_en: "Finished the exam" },
            { id: 59, hanzi: "æ¯•ä¸š", pinyin: "bÃ¬ yÃ¨", type: "missing", level: "HSK4", cat: "routine", mean: "Graduarse", mean_en: "Graduate", example: "æ¯•ä¸äº†ä¸š", ex_pin: "BÃ¬ bÃ¹ liÇo yÃ¨", ex_mean: "No poder graduarse", ex_mean_en: "Cannot graduate" }
        ];

        function init() {
            const storedKey = localStorage.getItem('gemini_api_key');
            if (storedKey) { userApiKey = storedKey; document.getElementById('api-key-input').value = storedKey; updateStatusDot(true); }
            const storedLang = localStorage.getItem('app_lang');
            if (storedLang) { currentLang = storedLang; }
            
            syncToggles();
            updateInterfaceLanguage();
            renderChart();
            applyFilters();
        }

        function syncToggles() {
            ['pinyin', 'mean'].forEach(field => {
                const checkbox = document.getElementById(`toggle-${field}`);
                const bg = document.getElementById(`vis-${field}-bg`);
                const dot = document.getElementById(`vis-${field}-dot`);
                viewState[field] = checkbox.checked;
                if (checkbox.checked) {
                    bg.classList.add('bg-green-400'); bg.classList.remove('bg-gray-300'); dot.classList.add('translate-x-full');
                } else {
                    bg.classList.remove('bg-green-400'); bg.classList.add('bg-gray-300'); dot.classList.remove('translate-x-full');
                }
            });
        }

        function switchTab(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabId}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tabId}`).classList.add('active');
            document.querySelectorAll('.mobile-nav-btn').forEach(el => el.classList.remove('text-red-700', 'font-bold'));
            document.getElementById(`mob-${tabId}`).classList.add('text-red-700', 'font-bold');
            window.scrollTo(0,0);
        }

        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('app_lang', lang);
            updateInterfaceLanguage();
            renderChart();
            applyFilters(); 
        }

        function toggleView(field) {
            const checkbox = document.getElementById(`toggle-${field}`);
            viewState[field] = checkbox.checked;
            
            const bg = document.getElementById(`vis-${field}-bg`);
            const dot = document.getElementById(`vis-${field}-dot`);
            if (checkbox.checked) {
                bg.classList.add('bg-green-400'); bg.classList.remove('bg-gray-300'); dot.classList.add('translate-x-full');
            } else {
                bg.classList.remove('bg-green-400'); bg.classList.add('bg-gray-300'); dot.classList.remove('translate-x-full');
            }

            const elements = document.querySelectorAll(`.view-${field}`);
            elements.forEach(el => {
                if (checkbox.checked) el.classList.remove('hidden-content');
                else el.classList.add('hidden-content');
            });
        }

        function updateInterfaceLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) { el.innerHTML = translations[currentLang][key]; }
            });
            document.getElementById('lang-btn-es').className = `flex-1 py-2 px-4 rounded border text-sm font-medium transition ${currentLang === 'es' ? 'bg-purple-600 text-white border-purple-600 shadow' : 'bg-white text-gray-600 hover:bg-gray-50'}`;
            document.getElementById('lang-btn-en').className = `flex-1 py-2 px-4 rounded border text-sm font-medium transition ${currentLang === 'en' ? 'bg-purple-600 text-white border-purple-600 shadow' : 'bg-white text-gray-600 hover:bg-gray-50'}`;
        }

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const content = document.getElementById('modal-content');
            if (modal.classList.contains('open')) {
                modal.classList.remove('open'); content.classList.remove('scale-100'); content.classList.add('scale-95');
            } else {
                modal.classList.add('open'); content.classList.remove('scale-95'); content.classList.add('scale-100');
            }
        }

        function saveSettings() {
            const input = document.getElementById('api-key-input');
            const key = input.value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key); userApiKey = key; updateStatusDot(true); toggleSettings();
            } else { alert(translations[currentLang].alert_key); }
        }

        function updateStatusDot(isActive) {
            const dot = document.getElementById('key-status-dot');
            dot.className = `absolute top-2 right-2 w-2 h-2 rounded-full ring-2 ring-white ${isActive ? 'bg-green-500' : 'bg-red-500'}`;
        }

        function renderChart() {
            const ctx = document.getElementById('vocabChart').getContext('2d');
            const t = translations[currentLang];
            
            const coreCount = verbs.filter(v => v.type === 'core').length;
            const phraseCount = verbs.filter(v => v.type === 'phrase').length;
            const missingCount = verbs.filter(v => v.type === 'missing').length;
            
            document.getElementById('total-verbs-count').innerText = verbs.length;

            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [t.chart_l1, t.chart_l2, t.chart_l3],
                    datasets: [{
                        data: [coreCount, phraseCount, missingCount],
                        backgroundColor: ['#C0392B', '#F1C40F', '#27AE60'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(context) { return ' ' + context.label + ': ' + context.raw; } } } }
                }
            });
        }

        function updateBadges(dataList) {
            const counts = { HSK1: 0, HSK2: 0, HSK3: 0, HSK4: 0 };
            
            let sourceList = verbs;
            if (filters.type !== 'all') {
                sourceList = verbs.filter(v => v.type === filters.type);
            }
            if (filters.cat !== 'all') {
                sourceList = sourceList.filter(v => v.cat === filters.cat);
            }

            sourceList.forEach(v => {
                if (counts[v.level] !== undefined) counts[v.level]++;
                if (parseInt(v.level.replace('HSK','')) >= 4) counts['HSK4']++;
            });

            document.getElementById('btn-hsk-1').innerText = `HSK 1 (${counts.HSK1})`;
            document.getElementById('btn-hsk-2').innerText = `HSK 2 (${counts.HSK2})`;
            document.getElementById('btn-hsk-3').innerText = `HSK 3 (${counts.HSK3})`;
            document.getElementById('btn-hsk-4').innerText = `HSK 4+ (${counts.HSK4})`;
        }

        function setFilter(category, value) {
            filters[category] = value;
            const buttons = document.querySelectorAll(category === 'type' ? '.filter-type' : (category === 'cat' ? '.filter-cat' : '.filter-hsk'));
            buttons.forEach(btn => {
                if (category === 'hsk') {
                    if (btn.dataset.val === value) btn.className = `filter-hsk px-2 py-1 rounded text-xs border border-transparent bg-gray-800 text-white hover:bg-gray-700 active-hsk`;
                    else btn.className = `filter-hsk px-2 py-1 rounded text-xs border border-gray-300 text-gray-600 hover:bg-white`;
                } else if (category === 'cat') {
                    if (btn.dataset.val === value) btn.className = `filter-cat px-3 py-1 rounded-full text-sm bg-gray-800 text-white shadow transition`;
                    else btn.className = `filter-cat px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition`;
                } else {
                    if (btn.dataset.val === value) btn.className = `filter-type px-3 py-1 rounded-full text-sm bg-gray-800 text-white shadow transition`;
                    else {
                        if (btn.dataset.val === 'core') btn.className = `filter-type px-3 py-1 rounded-full text-sm bg-red-100 text-red-800 hover:bg-red-200 transition`;
                        else if (btn.dataset.val === 'phrase') btn.className = `filter-type px-3 py-1 rounded-full text-sm bg-yellow-100 text-yellow-800 hover:bg-yellow-200 transition`;
                        else if (btn.dataset.val === 'missing') btn.className = `filter-type px-3 py-1 rounded-full text-sm bg-green-100 text-green-800 hover:bg-green-200 transition`;
                        else btn.className = `filter-type px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition`;
                    }
                }
            });
            applyFilters();
        }

        function applyFilters() {
            let filtered = verbs;
            if (filters.type !== 'all') filtered = filtered.filter(v => v.type === filters.type);
            if (filters.cat !== 'all') filtered = filtered.filter(v => v.cat === filters.cat);
            updateBadges(filtered);
            if (filters.hsk !== 'all') {
                if (filters.hsk === 'HSK4') filtered = filtered.filter(v => parseInt(v.level.replace('HSK','')) >= 4);
                else filtered = filtered.filter(v => v.level === filters.hsk);
            }
            renderCards(filtered);
        }

        function renderCards(data) {
            const container = document.getElementById('cards-container');
            const countDisplay = document.getElementById('filtered-count');
            countDisplay.innerText = data.length;
            container.innerHTML = '';
            const t = translations[currentLang];

            data.forEach(verb => {
                let tagColor, tagText, borderClass;
                if (verb.type === 'core') { tagColor = "bg-red-50 text-red-700"; tagText = t.tag_core; borderClass = "border-l-4 border-red-500"; }
                else if (verb.type === 'phrase') { tagColor = "bg-yellow-50 text-yellow-700"; tagText = t.tag_phrase; borderClass = "border-l-4 border-yellow-500"; }
                else if (verb.type === 'missing') { tagColor = "bg-green-50 text-green-700 font-bold"; tagText = t.tag_missing; borderClass = "border-l-4 border-green-500"; }

                const displayMean = currentLang === 'en' && verb.mean_en ? verb.mean_en : verb.mean;
                const char1 = verb.hanzi.charAt(0);
                const charRest = verb.hanzi.slice(1);
                
                const exPin = verb.ex_pin || "";
                const exMean = currentLang === 'en' ? (verb.ex_mean_en || "") : (verb.ex_mean || "");
                const pinyinHidden = viewState.pinyin ? '' : 'hidden-content';
                const meanHidden = viewState.mean ? '' : 'hidden-content';

                let catIcon = "ğŸ“Œ";
                if (verb.cat === 'social') catIcon = "ğŸ—£ï¸";
                else if (verb.cat === 'motion') catIcon = "ğŸƒâ€â™‚ï¸";
                else if (verb.cat === 'routine') catIcon = "ğŸ ";

                const card = document.createElement('div');
                card.className = `bg-white rounded-lg shadow-sm p-5 card ${borderClass} cursor-pointer hover:bg-stone-50 relative group`;
                card.onclick = (e) => { if(e.target.closest('.ai-interaction')) return; toggleExpand(card); };
                
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-baseline space-x-2">
                                <h3 class="hanzi-lg text-gray-800">${verb.hanzi}</h3>
                                <span class="pinyin font-serif view-pinyin ${pinyinHidden}">${verb.pinyin}</span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1 view-mean ${meanHidden}">${displayMean}</p>
                        </div>
                        <div class="flex flex-col items-end space-y-1">
                            <span class="text-xs" title="Category">${catIcon}</span>
                            <span class="text-[10px] uppercase tracking-wider px-2 py-1 rounded bg-stone-100 text-stone-500 font-bold">${verb.level}</span>
                            <span class="text-[10px] uppercase tracking-wider px-2 py-1 rounded ${tagColor}">${tagText}</span>
                        </div>
                    </div>
                    <div class="expand-content mt-4 border-t border-dashed border-gray-200 pt-3">
                        <div class="text-sm text-gray-600 mb-2 font-semibold flex justify-between"><span>${t.split_label}</span></div>
                        <div class="bg-gray-100 p-3 rounded text-center">
                            <span class="text-lg font-bold text-gray-800">${char1}</span><span class="text-red-600 mx-1 text-sm italic">...</span><span class="text-lg font-bold text-gray-800">${charRest}</span>
                        </div>
                        <div class="mt-3 text-center">
                             <p class="text-sm text-gray-800 italic font-medium">"${verb.example}"</p>
                             <p class="text-xs text-gray-500 mt-1 font-serif view-pinyin ${pinyinHidden}">${exPin}</p>
                             <p class="text-xs text-purple-700 mt-1 view-mean ${meanHidden}">${exMean}</p>
                        </div>
                        <div class="mt-4 pt-3 border-t border-gray-100 ai-interaction space-y-2">
                            <button onclick="generateExample('${verb.hanzi}', '${displayMean}', this)" class="w-full text-xs font-bold text-purple-600 bg-purple-50 hover:bg-purple-100 py-2 rounded transition flex items-center justify-center"><span>${t.gen_btn}</span></button>
                            <button onclick="analyzeVerb('${verb.hanzi}', '${displayMean}', this)" class="w-full text-xs font-bold text-gray-600 bg-gray-100 hover:bg-gray-200 py-2 rounded transition flex items-center justify-center border border-gray-200"><span>${t.deep_btn}</span></button>
                            <div class="ai-result mt-2 text-xs text-gray-600 bg-white p-2 rounded border border-purple-100 hidden"></div>
                        </div>
                    </div>
                    <div class="text-center mt-2 text-gray-300 text-xs message-hint group-hover:text-red-400 transition-colors">${t.card_hint}</div>
                `;
                container.appendChild(card);
            });
        }

        function toggleExpand(cardElement) {
            const content = cardElement.querySelector('.expand-content');
            const hint = cardElement.querySelector('.message-hint');
            const isExpanded = content.classList.contains('active');
            document.querySelectorAll('.expand-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.message-hint').forEach(el => el.style.opacity = '1');
            if (!isExpanded) { content.classList.add('active'); hint.style.opacity = '0'; }
        }

        async function callGemini(prompt) {
            if (!userApiKey) { toggleSettings(); return null; }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error();
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) { return null; }
        }

        // --- NEW JSON EXTRACTOR ---
        function cleanAndParseJSON(text) {
            try {
                const startIndex = text.indexOf('{');
                const endIndex = text.lastIndexOf('}');
                if (startIndex !== -1 && endIndex !== -1) {
                    return JSON.parse(text.substring(startIndex, endIndex + 1));
                }
                return JSON.parse(text);
            } catch (e) { return null; }
        }

        async function generateExample(word, meaning, btn) {
            const t = translations[currentLang];
            const resultDiv = btn.nextElementSibling.nextElementSibling;
            const originalText = btn.innerHTML;
            if (!userApiKey) { toggleSettings(); return; }
            btn.innerHTML = `<span class="loader" style="width:12px; height:12px; border-width:2px;"></span> ${t.gen_loading}`; btn.disabled = true; resultDiv.classList.add('hidden');
            const langInstr = t.prompt_lang_instruction;
            const prompt = `Generate a short Chinese sentence (HSK3 level) using the separable verb "${word}" (${meaning}). IMPORTANT: You MUST split the verb (A-le-B, A-zhe-B, etc). Return ONLY JSON: {"hanzi": "sentence", "pinyin": "pinyin", "translation": "translation ${langInstr}"}`;
            const text = await callGemini(prompt);
            
            if (text) {
                const data = cleanAndParseJSON(text);
                if (data) {
                    resultDiv.innerHTML = `<div class="font-bold text-gray-800 mb-1">${data.hanzi}</div><div class="text-gray-500 mb-1 font-serif italic view-pinyin ${viewState.pinyin ? '' : 'hidden-content'}">${data.pinyin}</div><div class="text-purple-700 view-mean ${viewState.mean ? '' : 'hidden-content'}">${data.translation}</div>`; 
                    resultDiv.classList.remove('hidden');
                } else {
                    resultDiv.innerHTML = `<span class="text-red-500 text-xs">Error analyzing data. Try again.</span>`;
                    resultDiv.classList.remove('hidden');
                }
            } else { resultDiv.innerHTML = t.ai_error; resultDiv.classList.remove('hidden'); }
            btn.innerHTML = originalText; btn.disabled = false;
        }

        async function analyzeVerb(word, meaning, btn) {
            const t = translations[currentLang];
            const resultDiv = btn.nextElementSibling;
            const originalText = btn.innerHTML;
            if (!userApiKey) { toggleSettings(); return; }
            btn.innerHTML = `<span class="loader" style="width:12px; height:12px; border-width:2px;"></span> ${t.deep_loading}`; 
            btn.disabled = true; resultDiv.classList.add('hidden');

            const langInstr = t.prompt_lang_instruction;
            const prompt = `Analyze the Chinese separable verb '${word}' (${meaning}). Provide a linguistic breakdown in JSON format. Do not use Markdown blocks.
            Output JSON keys:
            - "composition": Explain the individual characters (etymology/logic).
            - "syntax": Common errors (e.g. placement of time duration) and correct usage rules.
            - "pragmatics": Context (when is it used? is it formal/informal?).
            Language of response: ${currentLang === 'es' ? 'Spanish' : 'English'}.
            JSON format: {"composition": "...", "syntax": "...", "pragmatics": "..."}`;

            const text = await callGemini(prompt);

            if (text) {
                const data = cleanAndParseJSON(text);
                if (data) {
                    resultDiv.innerHTML = `
                        <div class="analysis-box text-left">
                            <div class="mb-3">
                                <h4 class="analysis-section-title"><span>${t.analysis_comp}</span></h4>
                                <p class="text-gray-600 leading-snug">${data.composition}</p>
                            </div>
                            <div class="mb-3">
                                <h4 class="analysis-section-title"><span>${t.analysis_syn}</span></h4>
                                <p class="text-gray-600 leading-snug">${data.syntax}</p>
                            </div>
                            <div>
                                <h4 class="analysis-section-title"><span>${t.analysis_prag}</span></h4>
                                <p class="text-gray-600 leading-snug">${data.pragmatics}</p>
                            </div>
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                } else {
                    resultDiv.innerHTML = `<span class="text-red-500 text-xs">Error parsing AI response. Try again.</span>`;
                    resultDiv.classList.remove('hidden');
                }
            } else { 
                resultDiv.innerHTML = t.ai_error; 
                resultDiv.classList.remove('hidden'); 
            }
            btn.innerHTML = originalText; 
            btn.disabled = false;
        }

        async function checkGrammar() {
            const input = document.getElementById('grammar-input').value;
            if (!input.trim()) return;
            if (!userApiKey) { toggleSettings(); return; }
            const loader = document.getElementById('grammar-loader'); const resultArea = document.getElementById('grammar-result');
            loader.classList.remove('hidden'); resultArea.innerHTML = "";
            const t = translations[currentLang];
            const prompt = `Act as a Chinese grammar teacher. Analyze this sentence: "${input}". Focus on Separable Verbs (Liheci). Output format: 1. Verdict: âœ… or âŒ 2. Explanation: (${t.prompt_lang_instruction}, explain why). 3. Correction: (If incorrect, corrected Chinese + Pinyin).`;
            const text = await callGemini(prompt);
            loader.classList.add('hidden');
            if (text) { resultArea.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'); }
            else { resultArea.innerHTML = `<span class='text-red-500'>${t.ai_error}</span>`; }
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
