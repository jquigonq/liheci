<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSK Separable Verbs (Á¶ªÂêàËØç)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* Chosen Palette: Zen Academy */
        :root {
            --color-bg: #F9F7F2;
            --color-text: #2C3E50;
            --color-accent: #C0392B;
            --color-secondary: #7F8C8D;
            --color-highlight: #D4AC0D;
            --color-success: #27AE60;
            --color-ai: #8E44AD;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: 'Noto Sans SC', sans-serif;
        }

        h1, h2, h3, .chinese-font {
            font-family: 'Noto Serif SC', serif;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            height: 300px;
        }

        .card {
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid transparent;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .card.type-core { border-left-color: var(--color-accent); }
        .card.type-phrase { border-left-color: var(--color-highlight); }
        .card.type-missing { border-left-color: var(--color-success); }

        .hanzi-lg { font-size: 1.5rem; font-weight: 700; }
        .pinyin { color: var(--color-secondary); font-size: 0.9rem; }

        .expand-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .expand-content.active {
            max-height: 500px;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--color-ai);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal.open {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="min-h-screen flex flex-col relative">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40 border-b border-stone-200">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <span class="text-2xl text-red-700 font-bold border-2 border-red-700 p-1 rounded">Á¶ªÂêà</span>
                <div>
                    <h1 class="text-xl font-bold text-gray-800" data-i18n="app_title">Auditor de Verbos Separables</h1>
                    <p class="text-xs text-gray-500"><span data-i18n="app_subtitle">An√°lisis ling√º√≠stico + IA</span> <span class="text-[10px] ml-1">‚ú®</span></p>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <nav class="hidden md:flex space-x-6 text-sm font-medium text-gray-600">
                    <a href="#audit" class="hover:text-red-700 transition" data-i18n="nav_audit">Auditor√≠a</a>
                    <a href="#list" class="hover:text-red-700 transition" data-i18n="nav_list">Tu Lista</a>
                    <a href="#lab" class="hover:text-purple-700 transition font-bold text-purple-600" data-i18n="nav_lab">Laboratorio IA ‚ú®</a>
                </nav>
                
                <button onclick="toggleSettings()" class="text-gray-500 hover:text-gray-800 transition p-2 rounded-full hover:bg-gray-100 relative group" title="Configurar / Settings">
                    <span class="text-xl">‚öôÔ∏è</span>
                    <span id="key-status-dot" class="absolute top-2 right-2 w-2 h-2 rounded-full bg-red-500 ring-2 ring-white"></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 relative transform transition-all scale-95" id="modal-content">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
            
            <h3 class="text-xl font-bold text-gray-800 mb-2" data-i18n="modal_title">Configuraci√≥n</h3>
            
            <!-- Language Selector -->
            <div class="mb-6 border-b border-gray-100 pb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2" data-i18n="modal_lang_label">Idioma / Language</label>
                <div class="flex space-x-2">
                    <button onclick="changeLanguage('es')" id="lang-btn-es" class="flex-1 py-2 px-4 rounded border text-sm font-medium transition hover:bg-gray-50">Espa√±ol üá™üá∏</button>
                    <button onclick="changeLanguage('en')" id="lang-btn-en" class="flex-1 py-2 px-4 rounded border text-sm font-medium transition hover:bg-gray-50">English üá∫üá∏</button>
                </div>
            </div>

            <p class="text-sm text-gray-600 mb-4" data-i18n="modal_desc">Para usar las funciones de IA, necesitas una API Key.</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Gemini API Key</label>
                    <input type="password" id="api-key-input" class="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition" placeholder="Paste your key (AIza...)">
                    <p class="text-xs text-gray-400 mt-1" data-i18n="modal_privacy">Tu clave se guarda localmente en tu navegador.</p>
                </div>
                
                <div class="flex justify-between items-center pt-2">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-purple-600 hover:underline font-medium" data-i18n="modal_get_key">Obtener clave gratis ‚Üó</a>
                    <button onclick="saveSettings()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded shadow transition" data-i18n="modal_save">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 space-y-12">

        <!-- Intro -->
        <section class="max-w-3xl mx-auto text-center space-y-4">
            <h2 class="text-3xl font-bold text-gray-800" data-i18n="intro_title">¬øEst√° completa tu lista?</h2>
            <p class="text-gray-600 leading-relaxed">
                <span data-i18n="intro_p1">He analizado el documento. Tu lista contiene</span> 
                <span id="total-count" class="font-bold text-red-700">0</span> 
                <span data-i18n="intro_p2">verbos. Aunque cubre los b√°sicos, faltan conceptos abstractos clave.</span>
            </p>
        </section>

        <!-- Audit Dashboard -->
        <section id="audit" class="grid md:grid-cols-2 gap-8 items-center bg-white p-6 rounded-xl shadow-sm border border-stone-100">
            <div>
                <h3 class="text-xl font-bold mb-4 border-l-4 border-red-700 pl-3" data-i18n="audit_title">Resumen del An√°lisis</h3>
                <ul class="space-y-4">
                    <li class="flex items-start">
                        <span class="text-2xl mr-3">üßê</span>
                        <div>
                            <strong class="block text-gray-800" data-i18n="audit_point1_title">La distinci√≥n t√©cnica</strong>
                            <p class="text-sm text-gray-600" data-i18n="audit_point1_desc">Tu lista incluye "Comprar coche" (‰π∞ËΩ¶). Aunque gramaticalmente se separa igual, no es un verbo inseparable abstracto como "Nadar" (Ê∏∏Ê≥≥).</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <span class="text-2xl mr-3">üìâ</span>
                        <div>
                            <strong class="block text-gray-800" data-i18n="audit_point2_title">Faltantes Importantes</strong>
                            <p class="text-sm text-gray-600" data-i18n="audit_point2_desc">Faltan verbos sociales cr√≠ticos como "Encontrarse" (ËßÅÈù¢) y "Charlar" (ËÅäÂ§©).</p>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="flex flex-col items-center">
                <div class="chart-container">
                    <canvas id="auditChart"></canvas>
                </div>
                <p class="text-xs text-gray-400 mt-2 text-center" data-i18n="chart_caption">Distribuci√≥n del contenido</p>
            </div>
        </section>

        <!-- Filters -->
        <div class="flex justify-center flex-wrap gap-2 sticky top-20 z-30 py-2 bg-[var(--color-bg)]/95 backdrop-blur">
            <button onclick="filterList('all')" class="px-4 py-1 rounded-full text-sm font-medium bg-gray-200 hover:bg-gray-300 text-gray-700 transition active-filter" id="btn-all" data-i18n="filter_all">Todos</button>
            <button onclick="filterList('core')" class="px-4 py-1 rounded-full text-sm font-medium bg-red-100 hover:bg-red-200 text-red-800 transition" id="btn-core" data-i18n="filter_core">Separables Puros</button>
            <button onclick="filterList('phrase')" class="px-4 py-1 rounded-full text-sm font-medium bg-yellow-100 hover:bg-yellow-200 text-yellow-800 transition" id="btn-phrase" data-i18n="filter_phrase">Frases V+O</button>
            <button onclick="filterList('missing')" class="px-4 py-1 rounded-full text-sm font-medium bg-green-100 hover:bg-green-200 text-green-800 transition" id="btn-missing" data-i18n="filter_missing">Faltantes (A√±adidos)</button>
        </div>

        <!-- The List Grid -->
        <section id="list" class="space-y-6">
            <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Javascript will populate this -->
            </div>
        </section>

        <!-- AI Grammar Lab -->
        <section id="lab" class="bg-white rounded-xl shadow-lg border border-purple-100 overflow-hidden">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 text-white">
                <h3 class="text-2xl font-bold flex items-center">
                    <span class="text-3xl mr-3">üß™</span> <span data-i18n="lab_title">Laboratorio de Gram√°tica IA</span>
                </h3>
                <p class="text-purple-100 text-sm mt-1" data-i18n="lab_subtitle">Escribe una frase y la IA verificar√° la estructura del verbo separable.</p>
            </div>
            <div class="p-6 md:p-8 grid md:grid-cols-2 gap-8">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2" data-i18n="lab_input_label">Tu frase en chino:</label>
                        <textarea id="grammar-input" rows="4" class="w-full p-4 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition bg-gray-50" placeholder="e.g.: ÊàëÁù°Ëßâ‰∫Ü‰∏â‰∏™Â∞èÊó∂ ..."></textarea>
                    </div>
                    <button onclick="checkGrammar()" id="btn-check-grammar" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg shadow transition flex items-center justify-center space-x-2">
                        <span data-i18n="lab_button">Analizar Gram√°tica ‚ú®</span>
                    </button>
                </div>
                <div class="bg-stone-50 rounded-lg p-6 border border-stone-200 relative min-h-[200px]">
                    <h4 class="text-xs uppercase tracking-wide text-gray-500 font-bold mb-3" data-i18n="lab_result_title">Diagn√≥stico de la IA</h4>
                    <div id="grammar-result" class="text-gray-600 text-sm leading-relaxed">
                        <p class="italic text-gray-400" data-i18n="lab_placeholder">El resultado aparecer√° aqu√≠...</p>
                    </div>
                    <div id="grammar-loader" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center">
                        <div class="flex flex-col items-center">
                            <div class="loader mb-2"></div>
                            <span class="text-xs text-purple-600 font-bold" data-i18n="lab_loading">Analizando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Educational Focus -->
        <section id="nuance" class="bg-stone-100 rounded-xl p-8 border-t-4 border-yellow-500">
            <div class="flex flex-col md:flex-row gap-8">
                <div class="md:w-1/3">
                    <h3 class="text-2xl font-bold text-gray-800 mb-2" data-i18n="edu_title">El caso de "Comprar Coche"</h3>
                    <div class="text-6xl font-serif text-center my-6 text-gray-300">VS</div>
                </div>
                <div class="md:w-2/3 space-y-4">
                    <p class="text-gray-700" data-i18n="edu_p1">
                        En tu lista aparece <strong>‰π∞ËΩ¶ (M«éi chƒì)</strong>. ¬øPor qu√© es diferente a <strong>Ê∏∏Ê≥≥ (Y√≥u y«íng)</strong>?
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white p-4 rounded shadow-sm">
                            <h4 class="font-bold text-red-700" data-i18n="edu_card1_title">Verbo Separable Puro</h4>
                            <p class="text-sm text-gray-600 mt-1" data-i18n="edu_card1_desc">El "Objeto" (Ê≥≥) no tiene mucho sentido por s√≠ solo hoy en d√≠a.</p>
                        </div>
                        <div class="bg-white p-4 rounded shadow-sm">
                            <h4 class="font-bold text-yellow-700" data-i18n="edu_card2_title">Frase Verbo + Objeto</h4>
                            <p class="text-sm text-gray-600 mt-1" data-i18n="edu_card2_desc">Es simplemente el verbo "Comprar" y el objeto "Coche".</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-gray-800 text-gray-400 py-8 text-center text-sm">
        <p data-i18n="footer">Generado por Canvas Create Webapp para an√°lisis de HSK.</p>
        <p class="mt-2 text-xs">Potenciado por Gemini API ‚ú®</p>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        // --- TRANSLATIONS ---
        const translations = {
            es: {
                app_title: "Auditor de Verbos Separables",
                app_subtitle: "An√°lisis ling√º√≠stico + IA",
                nav_audit: "Auditor√≠a",
                nav_list: "Tu Lista",
                nav_lab: "Laboratorio IA ‚ú®",
                modal_title: "Configuraci√≥n",
                modal_lang_label: "Idioma / Language",
                modal_desc: "Para usar las funciones de IA, necesitas una API Key.",
                modal_privacy: "Tu clave se guarda localmente en tu navegador.",
                modal_get_key: "Obtener clave gratis ‚Üó",
                modal_save: "Guardar",
                intro_title: "¬øEst√° completa tu lista?",
                intro_p1: "He analizado el documento. Tu lista contiene",
                intro_p2: "verbos. Aunque cubre los b√°sicos, faltan conceptos abstractos clave.",
                audit_title: "Resumen del An√°lisis",
                audit_point1_title: "La distinci√≥n t√©cnica",
                audit_point1_desc: "Tu lista incluye 'Comprar coche' (‰π∞ËΩ¶). Aunque gramaticalmente se separa igual, no es un verbo inseparable abstracto como 'Nadar' (Ê∏∏Ê≥≥).",
                audit_point2_title: "Faltantes Importantes",
                audit_point2_desc: "Faltan verbos sociales cr√≠ticos como 'Encontrarse' (ËßÅÈù¢) y 'Charlar' (ËÅäÂ§©).",
                chart_caption: "Distribuci√≥n del contenido",
                filter_all: "Todos",
                filter_core: "Separables Puros",
                filter_phrase: "Frases V+O",
                filter_missing: "Faltantes (A√±adidos)",
                lab_title: "Laboratorio de Gram√°tica IA",
                lab_subtitle: "Escribe una frase y la IA verificar√° la estructura del verbo separable.",
                lab_input_label: "Tu frase en chino:",
                lab_button: "Analizar Gram√°tica ‚ú®",
                lab_result_title: "Diagn√≥stico de la IA",
                lab_placeholder: "El resultado aparecer√° aqu√≠...",
                lab_loading: "Analizando...",
                edu_title: "El caso de 'Comprar Coche'",
                edu_p1: "En tu lista aparece <strong>‰π∞ËΩ¶ (M«éi chƒì)</strong>. ¬øPor qu√© es diferente a <strong>Ê∏∏Ê≥≥ (Y√≥u y«íng)</strong>?",
                edu_card1_title: "Verbo Separable Puro",
                edu_card1_desc: "El 'Objeto' (Ê≥≥) no tiene mucho sentido por s√≠ solo hoy en d√≠a.",
                edu_card2_title: "Frase Verbo + Objeto",
                edu_card2_desc: "Es simplemente el verbo 'Comprar' y el objeto 'Coche'.",
                footer: "Generado por Canvas Create Webapp para an√°lisis de HSK.",
                
                // Dynamic JS strings
                tag_core: "Separable Puro",
                tag_phrase: "Frase V+O",
                tag_missing: "Faltante",
                split_label: "Separaci√≥n:",
                gen_btn: "Generar Ejemplo Nuevo ‚ú®",
                gen_loading: "Generando...",
                card_hint: "üëá Toca para ver estructura",
                chart_label_1: "Separables Puros",
                chart_label_2: "Frases V+O",
                chart_label_3: "Faltantes",
                alert_key: "Por favor, introduce una clave v√°lida.",
                alert_error: "Error de API Key: Clave inv√°lida.",
                ai_error: "Error de conexi√≥n o clave.",
                prompt_lang_instruction: "in Spanish"
            },
            en: {
                app_title: "Separable Verbs Auditor",
                app_subtitle: "Linguistic Analysis + AI",
                nav_audit: "Audit",
                nav_list: "Your List",
                nav_lab: "AI Lab ‚ú®",
                modal_title: "Settings",
                modal_lang_label: "Language / Idioma",
                modal_desc: "To use AI features, you need an API Key.",
                modal_privacy: "Your key is stored locally in your browser.",
                modal_get_key: "Get free key ‚Üó",
                modal_save: "Save",
                intro_title: "Is your list complete?",
                intro_p1: "I have analyzed the document. Your list contains",
                intro_p2: "verbs. While it covers basics, key abstract concepts are missing.",
                audit_title: "Analysis Summary",
                audit_point1_title: "Technical Distinction",
                audit_point1_desc: "Your list includes 'Buy car' (‰π∞ËΩ¶). While grammatically separable, it's not an abstract separable verb like 'Swim' (Ê∏∏Ê≥≥).",
                audit_point2_title: "Important Missing Verbs",
                audit_point2_desc: "Critical social verbs like 'Meet' (ËßÅÈù¢) and 'Chat' (ËÅäÂ§©) are missing.",
                chart_caption: "Content Distribution",
                filter_all: "All",
                filter_core: "True Separable",
                filter_phrase: "VO Phrase",
                filter_missing: "Missing (Added)",
                lab_title: "AI Grammar Lab",
                lab_subtitle: "Type a sentence and AI will verify the separable verb structure.",
                lab_input_label: "Your Chinese sentence:",
                lab_button: "Analyze Grammar ‚ú®",
                lab_result_title: "AI Diagnosis",
                lab_placeholder: "Result will appear here...",
                lab_loading: "Analyzing...",
                edu_title: "The 'Buy Car' Case",
                edu_p1: "Your list has <strong>‰π∞ËΩ¶ (M«éi chƒì)</strong>. Why is it different from <strong>Ê∏∏Ê≥≥ (Y√≥u y«íng)</strong>?",
                edu_card1_title: "True Separable Verb",
                edu_card1_desc: "The 'Object' (Ê≥≥) doesn't make much sense on its own nowadays.",
                edu_card2_title: "Verb + Object Phrase",
                edu_card2_desc: "It is simply the verb 'Buy' and the object 'Car'.",
                footer: "Generated by Canvas Create Webapp for HSK analysis.",

                // Dynamic JS strings
                tag_core: "True Separable",
                tag_phrase: "VO Phrase",
                tag_missing: "Missing",
                split_label: "Split:",
                gen_btn: "Generate New Example ‚ú®",
                gen_loading: "Generating...",
                card_hint: "üëá Tap to view structure",
                chart_label_1: "True Separables",
                chart_label_2: "VO Phrases",
                chart_label_3: "Missing Items",
                alert_key: "Please enter a valid key.",
                alert_error: "API Key Error: Invalid key.",
                ai_error: "Connection or Key error.",
                prompt_lang_instruction: "in English"
            }
        };

        // --- APP STATE ---
        let currentLang = 'es';
        let userApiKey = "";
        let myChart = null;

        // --- DATA (Bilingual) ---
        const verbs = [
            // Core
            { id: 1, hanzi: "Ë∑ëÊ≠•", pinyin: "p«éo b√π", type: "core", level: "HSK2", mean: "Correr", mean_en: "Run / Jog", example: "Ë∑ë‰∫Ü‰∫åÂçÅÂàÜÈíüÊ≠•" },
            { id: 2, hanzi: "Êï£Ê≠•", pinyin: "s√†n b√π", type: "core", level: "HSK4", mean: "Dar un paseo", mean_en: "Take a walk", example: "Êï£‰∫Ü‰∏Ä‰ºöÂÑøÊ≠•" },
            { id: 3, hanzi: "Ê∏∏Ê≥≥", pinyin: "y√≥u y«íng", type: "core", level: "HSK2", mean: "Nadar", mean_en: "Swim", example: "Ê∏∏Ëøá‰∏ÄÊ¨°Ê≥≥" },
            { id: 4, hanzi: "Ë∏¢Ë∂≥ÁêÉ", pinyin: "tƒ´ z√∫qi√∫", type: "phrase", level: "HSK2", mean: "Jugar f√∫tbol", mean_en: "Play soccer", example: "Ë∏¢‰∫Ü‰∏ÄÂú∫Ë∂≥ÁêÉ" },
            { id: 5, hanzi: "ÊâìÁØÆÁêÉ", pinyin: "d«é l√°nqi√∫", type: "phrase", level: "HSK2", mean: "Jugar baloncesto", mean_en: "Play basketball", example: "ÊâìËøáÁØÆÁêÉÂêóÔºü" },
            { id: 6, hanzi: "ÊâìÊ©ÑÊ¶ÑÁêÉ", pinyin: "d«é g«énl«énqi√∫", type: "phrase", level: "HSK5", mean: "Jugar rugby", mean_en: "Play rugby", example: "ÊâìÊâìÊ©ÑÊ¶ÑÁêÉ" }, 
            { id: 7, hanzi: "ÊâìËΩ¶", pinyin: "d«é chƒì", type: "core", level: "HSK4", mean: "Tomar taxi", mean_en: "Take a taxi", example: "Êâì‰∏çÂà∞ËΩ¶" },
            { id: 8, hanzi: "È™ëËΩ¶", pinyin: "q√≠ chƒì", type: "phrase", level: "HSK2", mean: "Montar bici", mean_en: "Ride a bike", example: "È™ëÁùÄËΩ¶Âéª" },
            { id: 9, hanzi: "ÂÅúËΩ¶", pinyin: "t√≠ng chƒì", type: "phrase", level: "HSK4", mean: "Aparcar", mean_en: "Park a car", example: "ÂÅúÂ•ΩËΩ¶" },
            { id: 10, hanzi: "‰π∞ËΩ¶", pinyin: "m«éi chƒì", type: "phrase", level: "HSK1", mean: "Comprar coche", mean_en: "Buy a car", example: "‰π∞‰∫Ü‰∏âËæÜËΩ¶" },
            { id: 11, hanzi: "Âî±Ê≠å", pinyin: "ch√†ng gƒì", type: "core", level: "HSK2", mean: "Cantar", mean_en: "Sing", example: "Âî±‰∏ÄÈ¶ñÊ≠å" },
            { id: 12, hanzi: "Ë∑≥Ëàû", pinyin: "ti√†o w«î", type: "core", level: "HSK2", mean: "Bailar", mean_en: "Dance", example: "Ë∑≥Ë∑≥Ëàû" },
            { id: 13, hanzi: "Áúã‰π¶", pinyin: "k√†n sh≈´", type: "phrase", level: "HSK1", mean: "Leer", mean_en: "Read a book", example: "Áúã‰∫ÜÂçäÂ§©‰π¶" },
            { id: 14, hanzi: "ÁúãÁîµÂΩ±", pinyin: "k√†n di√†ny«êng", type: "phrase", level: "HSK1", mean: "Ver pel√≠cula", mean_en: "Watch movie", example: "Áúã‰∏ÄÂú∫ÁîµÂΩ±" },
            { id: 15, hanzi: "ÊãçÁÖß", pinyin: "pƒÅi zh√†o", type: "core", level: "HSK3", mean: "Tomar fotos", mean_en: "Take photos", example: "Êãç‰∏§Âº†ÁÖß" },
            { id: 16, hanzi: "Ëµ∑Â∫ä", pinyin: "q«ê chu√°ng", type: "core", level: "HSK2", mean: "Levantarse", mean_en: "Get up", example: "Ëµ∑ÂæóÊù•Â∫ä" },
            { id: 17, hanzi: "Âà∑Áâô", pinyin: "shuƒÅ y√°", type: "core", level: "HSK3", mean: "Cepillar dientes", mean_en: "Brush teeth", example: "Âà∑ÂÆåÁâô" },
            { id: 18, hanzi: "Ê¥óËÑ∏", pinyin: "x«ê li«én", type: "phrase", level: "HSK3", mean: "Lavar cara", mean_en: "Wash face", example: "Ê¥óÊ¥óËÑ∏" },
            { id: 19, hanzi: "Ê¥óÊæ°", pinyin: "x«ê z«éo", type: "core", level: "HSK3", mean: "Ba√±arse", mean_en: "Take a bath", example: "Ê¥ó‰∫Ü‰∏Ä‰∏™ÁÉ≠Ê∞¥Êæ°" },
            { id: 20, hanzi: "Áù°Ëßâ", pinyin: "shu√¨ ji√†o", type: "core", level: "HSK1", mean: "Dormir", mean_en: "Sleep", example: "Áù°‰∏™Â•ΩËßâ" },
            { id: 21, hanzi: "ÂåñÂ¶Ü", pinyin: "hu√† zhuƒÅng", type: "core", level: "HSK4", mean: "Maquillarse", mean_en: "Put on makeup", example: "Âåñ‰∫ÜÊµìÂ¶Ü" },
            { id: 22, hanzi: "ÁîüÁóÖ", pinyin: "shƒìng b√¨ng", type: "core", level: "HSK2", mean: "Enfermarse", mean_en: "Get sick", example: "Áîü‰∫Ü‰∏ÄÂú∫Â§ßÁóÖ" },
            // Missing
            { id: 23, hanzi: "ËßÅÈù¢", pinyin: "ji√†n mi√†n", type: "missing", level: "HSK3", mean: "Verse / Encontrarse", mean_en: "Meet / See each other", example: "Ë∑üÊúãÂèãËßÅ‰∏™Èù¢" },
            { id: 24, hanzi: "Â∏ÆÂøô", pinyin: "bƒÅng m√°ng", type: "missing", level: "HSK3", mean: "Ayudar", mean_en: "Help / Do a favor", example: "Â∏Æ‰∫ÜÊàë‰∏Ä‰∏™Â§ßÂøô" },
            { id: 25, hanzi: "ËÅäÂ§©", pinyin: "li√°o tiƒÅn", type: "missing", level: "HSK3", mean: "Charlar", mean_en: "Chat", example: "ËÅä‰∫Ü‰∏Ä‰ºöÂÑøÂ§©" },
            { id: 26, hanzi: "ÁîüÊ∞î", pinyin: "shƒìng q√¨", type: "missing", level: "HSK3", mean: "Enfadarse", mean_en: "Get angry", example: "ÁîüËøáÊàëÁöÑÊ∞î" },
            { id: 27, hanzi: "ÁªìÂ©ö", pinyin: "ji√© h≈´n", type: "missing", level: "HSK3", mean: "Casarse", mean_en: "Get married", example: "ÁªìËøá‰∏§Ê¨°Â©ö" },
            { id: 28, hanzi: "ËØ∑ÂÅá", pinyin: "q«êng ji√†", type: "missing", level: "HSK3", mean: "Pedir permiso/libre", mean_en: "Ask for leave", example: "ËØ∑‰∏âÂ§©ÂÅá" },
            { id: 29, hanzi: "ËÄÉËØï", pinyin: "k«éo sh√¨", type: "missing", level: "HSK2", mean: "Examinarse", mean_en: "Take an exam", example: "ËÄÉÂÆåËØï‰∫Ü" },
            { id: 30, hanzi: "ÊØï‰∏ö", pinyin: "b√¨ y√®", type: "missing", level: "HSK4", mean: "Graduarse", mean_en: "Graduate", example: "ÊØï‰∏ç‰∫Ü‰∏ö" }
        ];

        // --- INIT & LOGIC ---

        function init() {
            // Load settings
            const storedKey = localStorage.getItem('gemini_api_key');
            if (storedKey) {
                userApiKey = storedKey;
                document.getElementById('api-key-input').value = storedKey;
                updateStatusDot(true);
            } else {
                updateStatusDot(false);
            }

            const storedLang = localStorage.getItem('app_lang');
            if (storedLang) {
                currentLang = storedLang;
            }
            
            // Apply language & Render
            updateInterfaceLanguage();
            renderChart();
            renderCards(verbs);
        }

        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('app_lang', lang);
            updateInterfaceLanguage();
            
            // Re-render chart to update labels
            if(myChart) myChart.destroy();
            renderChart();
            
            // Re-render cards to update meanings
            // Get current active filter
            const activeBtn = document.querySelector('.active-filter');
            const type = activeBtn ? activeBtn.id.replace('btn-', '') : 'all';
            filterList(type);
        }

        function updateInterfaceLanguage() {
            // Update static texts
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) {
                    el.innerText = translations[currentLang][key];
                }
            });

            // Update buttons styles
            document.getElementById('lang-btn-es').className = `flex-1 py-2 px-4 rounded border text-sm font-medium transition ${currentLang === 'es' ? 'bg-purple-600 text-white border-purple-600 shadow' : 'bg-white text-gray-600 hover:bg-gray-50'}`;
            document.getElementById('lang-btn-en').className = `flex-1 py-2 px-4 rounded border text-sm font-medium transition ${currentLang === 'en' ? 'bg-purple-600 text-white border-purple-600 shadow' : 'bg-white text-gray-600 hover:bg-gray-50'}`;
        }

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const content = document.getElementById('modal-content');
            
            if (modal.classList.contains('open')) {
                modal.classList.remove('open');
                content.classList.remove('scale-100');
                content.classList.add('scale-95');
            } else {
                modal.classList.add('open');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }
        }

        function saveSettings() {
            const input = document.getElementById('api-key-input');
            const key = input.value.trim();
            
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                userApiKey = key;
                updateStatusDot(true);
                toggleSettings();
            } else {
                alert(translations[currentLang].alert_key);
            }
        }

        function updateStatusDot(isActive) {
            const dot = document.getElementById('key-status-dot');
            dot.className = `absolute top-2 right-2 w-2 h-2 rounded-full ring-2 ring-white ${isActive ? 'bg-green-500' : 'bg-red-500'}`;
        }

        function renderCards(data) {
            const container = document.getElementById('cards-container');
            const countDisplay = document.getElementById('total-count');
            countDisplay.innerText = verbs.filter(v => v.type !== 'missing').length;

            container.innerHTML = '';
            
            const t = translations[currentLang];

            data.forEach(verb => {
                let tagColor, tagText, borderClass;

                if (verb.type === 'core') {
                    tagColor = "bg-red-50 text-red-700";
                    tagText = t.tag_core;
                    borderClass = "border-l-4 border-red-500";
                } else if (verb.type === 'phrase') {
                    tagColor = "bg-yellow-50 text-yellow-700";
                    tagText = t.tag_phrase;
                    borderClass = "border-l-4 border-yellow-500";
                } else if (verb.type === 'missing') {
                    tagColor = "bg-green-50 text-green-700 font-bold";
                    tagText = t.tag_missing;
                    borderClass = "border-l-4 border-green-500";
                }

                // Choose language for meaning
                const displayMean = currentLang === 'en' && verb.mean_en ? verb.mean_en : verb.mean;

                const char1 = verb.hanzi.charAt(0);
                const charRest = verb.hanzi.slice(1);

                const card = document.createElement('div');
                card.className = `bg-white rounded-lg shadow-sm p-5 card ${borderClass} cursor-pointer hover:bg-stone-50 relative group`;
                card.onclick = (e) => {
                    if(e.target.closest('.ai-interaction')) return;
                    toggleExpand(card);
                };
                
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-baseline space-x-2">
                                <h3 class="hanzi-lg text-gray-800">${verb.hanzi}</h3>
                                <span class="pinyin font-serif">${verb.pinyin}</span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1">${displayMean}</p>
                        </div>
                        <span class="text-[10px] uppercase tracking-wider px-2 py-1 rounded ${tagColor}">${tagText}</span>
                    </div>
                    
                    <div class="expand-content mt-4 border-t border-dashed border-gray-200 pt-3">
                        <div class="text-sm text-gray-600 mb-2 font-semibold flex justify-between">
                            <span>${t.split_label}</span>
                            <span class="text-xs text-gray-400 font-normal">${verb.level}</span>
                        </div>
                        <div class="bg-gray-100 p-3 rounded text-center">
                            <span class="text-lg font-bold text-gray-800">${char1}</span>
                            <span class="text-red-600 mx-1 text-sm italic">...</span>
                            <span class="text-lg font-bold text-gray-800">${charRest}</span>
                        </div>
                        <p class="mt-2 text-sm text-gray-700 text-center italic">"${verb.example}"</p>

                        <div class="mt-4 pt-3 border-t border-gray-100 ai-interaction">
                            <button onclick="generateExample('${verb.hanzi}', '${displayMean}', this)" class="w-full text-xs font-bold text-purple-600 bg-purple-50 hover:bg-purple-100 py-2 rounded transition flex items-center justify-center">
                                <span>${t.gen_btn}</span>
                            </button>
                            <div class="ai-result mt-2 text-xs text-gray-600 bg-white p-2 rounded border border-purple-100 hidden"></div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-2 text-gray-300 text-xs message-hint group-hover:text-red-400 transition-colors">${t.card_hint}</div>
                `;
                container.appendChild(card);
            });
        }

        function toggleExpand(cardElement) {
            const content = cardElement.querySelector('.expand-content');
            const hint = cardElement.querySelector('.message-hint');
            const isExpanded = content.classList.contains('active');
            
            document.querySelectorAll('.expand-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.message-hint').forEach(el => el.style.opacity = '1');

            if (!isExpanded) {
                content.classList.add('active');
                hint.style.opacity = '0';
            }
        }

        function filterList(type) {
            document.querySelectorAll('button.active-filter').forEach(b => {
                b.classList.remove('ring-2', 'ring-offset-2', 'ring-gray-400');
            });
            document.getElementById(`btn-${type}`).classList.add('ring-2', 'ring-offset-2', 'ring-gray-400');

            if (type === 'all') {
                renderCards(verbs);
            } else {
                renderCards(verbs.filter(v => v.type === type));
            }
        }

        // --- AI CALLS ---
        
        async function callGemini(prompt) {
            if (!userApiKey) {
                toggleSettings();
                return null;
            }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error();
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                return null;
            }
        }

        async function generateExample(word, meaning, btn) {
            const t = translations[currentLang];
            const resultDiv = btn.nextElementSibling;
            const originalText = btn.innerHTML;
            
            if (!userApiKey) { toggleSettings(); return; }

            btn.innerHTML = `<span class="loader" style="width:12px; height:12px; border-width:2px;"></span> ${t.gen_loading}`;
            btn.disabled = true;
            resultDiv.classList.add('hidden');

            const langInstr = t.prompt_lang_instruction;
            const prompt = `Generate a short Chinese sentence (HSK3 level) using the separable verb "${word}" (${meaning}). 
            IMPORTANT: You MUST split the verb (A-le-B, A-zhe-B, etc). 
            Return ONLY JSON: {"hanzi": "sentence", "pinyin": "pinyin", "translation": "translation ${langInstr}"}`;

            const text = await callGemini(prompt);

            if (text) {
                try {
                    const jsonStr = text.replace(/```json|```/g, '').trim();
                    const data = JSON.parse(jsonStr);
                    resultDiv.innerHTML = `
                        <div class="font-bold text-gray-800 mb-1">${data.hanzi}</div>
                        <div class="text-gray-500 mb-1 font-serif italic">${data.pinyin}</div>
                        <div class="text-purple-700">${data.translation}</div>
                    `;
                    resultDiv.classList.remove('hidden');
                } catch (e) { resultDiv.innerHTML = "AI Parse Error"; resultDiv.classList.remove('hidden'); }
            } else {
                resultDiv.innerHTML = t.ai_error;
                resultDiv.classList.remove('hidden');
            }
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        async function checkGrammar() {
            const input = document.getElementById('grammar-input').value;
            if (!input.trim()) return;
            if (!userApiKey) { toggleSettings(); return; }

            const loader = document.getElementById('grammar-loader');
            const resultArea = document.getElementById('grammar-result');
            loader.classList.remove('hidden');
            resultArea.innerHTML = "";

            const t = translations[currentLang];
            const prompt = `Act as a Chinese grammar teacher. Analyze this sentence: "${input}". 
            Focus on Separable Verbs (Liheci). 
            Output format: 
            1. Verdict: ‚úÖ or ‚ùå
            2. Explanation: (${t.prompt_lang_instruction}, explain why).
            3. Correction: (If incorrect, corrected Chinese + Pinyin).`;

            const text = await callGemini(prompt);
            loader.classList.add('hidden');

            if (text) {
                resultArea.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            } else {
                resultArea.innerHTML = `<span class='text-red-500'>${t.ai_error}</span>`;
            }
        }

        function renderChart() {
            const ctx = document.getElementById('auditChart').getContext('2d');
            const t = translations[currentLang];
            
            const coreCount = verbs.filter(v => v.type === 'core').length;
            const phraseCount = verbs.filter(v => v.type === 'phrase').length;
            const missingCount = verbs.filter(v => v.type === 'missing').length;

            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [t.chart_label_1, t.chart_label_2, t.chart_label_3],
                    datasets: [{
                        data: [coreCount, phraseCount, missingCount],
                        backgroundColor: ['#C0392B', '#F1C40F', '#27AE60'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { family: 'Noto Sans SC', size: 10 } } }
                    }
                }
            });
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
