<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mastering Liheci (Á¶ªÂêàËØç)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* Palette */
        :root {
            --color-bg: #FDFBF7;
            --color-text: #2C3E50;
            --color-accent: #C0392B;
            --color-highlight: #D4AC0D;
            --color-success: #27AE60;
            --color-ai: #8E44AD;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: 'Noto Sans SC', sans-serif;
        }

        h1, h2, h3, .chinese-font {
            font-family: 'Noto Serif SC', serif;
        }

        /* Grammar Highlighting */
        .g-verb { color: #2980b9; font-weight: bold; }
        .g-obj { color: #27ae60; font-weight: bold; }
        .g-insert { color: #c0392b; border-bottom: 2px solid #c0392b; }

        /* Card Styles */
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid transparent;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .card.type-core { border-left-color: var(--color-accent); }
        .card.type-phrase { border-left-color: var(--color-highlight); }
        .card.type-missing { border-left-color: var(--color-success); }

        .hanzi-lg { font-size: 1.5rem; font-weight: 700; }
        .pinyin { color: #7F8C8D; font-size: 0.9rem; }

        /* Animation */
        .expand-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .expand-content.active {
            max-height: 800px;
        }

        /* Toggle Switch Visuals */
        .toggle-bg { transition: background-color 0.2s ease-in-out; }
        .toggle-dot { transition: transform 0.2s ease-in-out; }
        
        /* Utility for hiding content via Toggle */
        .hidden-content { display: none !important; }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--color-ai);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal.open {
            opacity: 1;
            pointer-events: auto;
        }

        .pattern-box {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            height: 100%;
        }

        /* TAB NAVIGATION */
        .nav-btn { position: relative; padding-bottom: 4px; }
        .nav-btn.active { color: var(--color-accent); font-weight: 700; }
        .nav-btn.active::after {
            content: ''; position: absolute; bottom: -20px; left: 0; width: 100%; height: 3px; background-color: var(--color-accent);
        }

        .view-section { display: none; opacity: 0; transition: opacity 0.3s ease-in; }
        .view-section.active { display: block; opacity: 1; }
    </style>
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="min-h-screen flex flex-col relative">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50 border-b border-stone-200">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer" onclick="switchTab('theory')">
                <span class="text-2xl text-red-700 font-bold border-2 border-red-700 p-1 rounded">Á¶ªÂêà</span>
                <div>
                    <h1 class="text-lg md:text-xl font-bold text-gray-800 leading-tight" data-i18n="app_title">Gu√≠a de Verbos Separables</h1>
                    <p class="text-xs text-gray-500 hidden md:block" data-i18n="app_subtitle">Gram√°tica y Vocabulario HSK</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <nav class="hidden md:flex space-x-8 text-sm font-medium text-gray-600 h-full items-center">
                    <button onclick="switchTab('theory')" id="nav-theory" class="nav-btn active transition hover:text-red-700" data-i18n="nav_theory">Teor√≠a</button>
                    <button onclick="switchTab('vocab')" id="nav-vocab" class="nav-btn transition hover:text-red-700" data-i18n="nav_vocab">Vocabulario</button>
                    <button onclick="switchTab('lab')" id="nav-lab" class="nav-btn transition hover:text-purple-700 text-purple-600 font-bold" data-i18n="nav_lab">Laboratorio IA ‚ú®</button>
                </nav>
                <button onclick="toggleSettings()" class="text-gray-500 hover:text-gray-800 transition p-2 rounded-full hover:bg-gray-100 relative group" title="Configurar / Settings">
                    <span class="text-xl">‚öôÔ∏è</span>
                    <span id="key-status-dot" class="absolute top-2 right-2 w-2 h-2 rounded-full bg-red-500 ring-2 ring-white"></span>
                </button>
            </div>
        </div>
        <!-- Mobile Nav -->
        <div class="md:hidden flex justify-around border-t border-gray-100 bg-white py-2 text-xs font-medium text-gray-600">
            <button onclick="switchTab('theory')" class="mobile-nav-btn p-2" id="mob-theory">Teor√≠a</button>
            <button onclick="switchTab('vocab')" class="mobile-nav-btn p-2" id="mob-vocab">Lista</button>
            <button onclick="switchTab('lab')" class="mobile-nav-btn p-2 text-purple-600" id="mob-lab">IA ‚ú®</button>
        </div>
    </header>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 relative transform transition-all scale-95" id="modal-content">
            <button onclick="toggleSettings()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">‚úï</button>
            <h3 class="text-xl font-bold text-gray-800 mb-2" data-i18n="modal_title">Configuraci√≥n</h3>
            <div class="mb-6 border-b border-gray-100 pb-6">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2" data-i18n="modal_lang_label">Idioma / Language</label>
                <div class="flex space-x-2">
                    <button onclick="changeLanguage('es')" id="lang-btn-es" class="flex-1 py-2 px-4 rounded border text-sm font-medium transition hover:bg-gray-50">Espa√±ol üá™üá∏</button>
                    <button onclick="changeLanguage('en')" id="lang-btn-en" class="flex-1 py-2 px-4 rounded border text-sm font-medium transition hover:bg-gray-50">English üá∫üá∏</button>
                </div>
            </div>
            <p class="text-sm text-gray-600 mb-4" data-i18n="modal_desc">Para usar las funciones de IA, necesitas una API Key.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Gemini API Key</label>
                    <input type="password" id="api-key-input" class="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none transition" placeholder="Paste your key (AIza...)">
                    <p class="text-xs text-gray-400 mt-1" data-i18n="modal_privacy">Tu clave se guarda localmente en tu navegador.</p>
                </div>
                <div class="flex justify-between items-center pt-2">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-purple-600 hover:underline font-medium" data-i18n="modal_get_key">Obtener clave gratis ‚Üó</a>
                    <button onclick="saveSettings()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded shadow transition" data-i18n="modal_save">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Wrapper -->
    <main class="flex-grow flex flex-col relative min-h-[calc(100vh-80px)]">

        <!-- THEORY TAB -->
        <section id="view-theory" class="view-section active bg-[#FDFBF7] py-10 md:py-16 fade-in">
            <div class="container mx-auto px-4 max-w-5xl space-y-12">
                <div class="text-center space-y-4">
                    <span class="text-sm font-bold tracking-widest text-red-600 uppercase" data-i18n="hero_tag">GRAM√ÅTICA HSK</span>
                    <h2 class="text-3xl md:text-5xl font-bold text-gray-800" data-i18n="theory_title">Gram√°tica de los Á¶ªÂêàËØç</h2>
                    <p class="text-gray-600 leading-relaxed text-lg max-w-2xl mx-auto" data-i18n="theory_intro">
                        En chino, verbos como "Dormir" (Áù°Ëßâ) no son una sola pieza. Son un <strong>"S√°ndwich"</strong> formado por una Acci√≥n (Verbo) y una Cosa (Objeto).
                    </p>
                </div>
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="pattern-box border-t-4 border-blue-500 shadow-sm">
                        <div class="text-4xl mb-4 text-center">ü•™</div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2 text-center" data-i18n="rule1_title">Estructura S√°ndwich</h3>
                        <p class="text-sm text-gray-600 mb-4 text-center" data-i18n="rule1_desc">Imagina que el verbo se abre para meter informaci√≥n dentro.</p>
                        <div class="bg-stone-50 p-3 rounded text-center font-serif text-lg">
                            <span class="g-verb" data-i18n="gram_verb">Verbo</span> + <span class="g-insert" data-i18n="gram_info">Info</span> + <span class="g-obj" data-i18n="gram_obj">Objeto</span>
                        </div>
                    </div>
                    <div class="pattern-box border-t-4 border-red-500 shadow-sm">
                        <div class="text-4xl mb-4 text-center">‚õî</div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2 text-center" data-i18n="rule2_title">Regla de Oro</h3>
                        <p class="text-sm text-gray-600 mb-4 text-center" data-i18n="rule2_desc">No puedes a√±adir otro objeto al final, ¬°ya tiene uno!</p>
                        <div class="bg-red-50 p-2 rounded text-xs text-center text-red-800 mb-1">
                            ‚ùå Êàë<span class="g-verb">ËßÅ</span><span class="g-obj">Èù¢</span> <span class="underline" data-i18n="gram_you">‰Ω†</span>
                        </div>
                        <div class="bg-green-50 p-2 rounded text-xs text-center text-green-800">
                            ‚úÖ ÊàëË∑ü<span class="underline" data-i18n="gram_you">‰Ω†</span> <span class="g-verb">ËßÅ</span><span class="g-obj">Èù¢</span>
                        </div>
                    </div>
                    <div class="pattern-box border-t-4 border-yellow-500 shadow-sm">
                        <div class="text-4xl mb-4 text-center">üí°</div>
                        <h3 class="text-lg font-bold text-gray-800 mb-2 text-center" data-i18n="rule3_title">V+O vs Separable Puro</h3>
                        <p class="text-sm text-gray-600 text-center" data-i18n="rule3_desc">
                            <strong>Comprar coche (‰π∞ËΩ¶)</strong> es literal.<br><strong>Nadar (Ê∏∏Ê≥≥)</strong> es abstracto.
                        </p>
                    </div>
                </div>
                <div class="text-center pt-8">
                    <button onclick="switchTab('vocab')" class="bg-red-700 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-red-800 transition transform hover:scale-105" data-i18n="btn_goto_vocab">Ir al Vocabulario ‚ûú</button>
                </div>
            </div>
        </section>

        <!-- VOCAB TAB -->
        <section id="view-vocab" class="view-section bg-gray-100 py-10 md:py-16 min-h-screen">
            <div class="container mx-auto px-4 max-w-5xl space-y-6">
                
                <div class="flex flex-col md:flex-row justify-between items-end md:items-center border-b border-gray-300 pb-4 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <span class="mr-2">üìö</span> <span data-i18n="vocab_title">Biblioteca de Verbos</span>
                    </h2>
                    <div class="text-sm text-gray-500 mt-2 md:mt-0">
                        <span id="filtered-count" class="font-bold text-gray-800">0</span> <span data-i18n="vocab_count_label">palabras mostradas</span>
                    </div>
                </div>

                <!-- CONTROLS & FILTERS -->
                <div class="space-y-4 sticky top-16 z-40 bg-gray-100/95 backdrop-blur py-3 shadow-sm -mx-4 px-4 md:mx-0 md:px-0 rounded-lg border-b border-gray-200">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <!-- Filters Left -->
                        <div class="space-y-2">
                            <div class="flex flex-wrap gap-2 items-center">
                                <span class="text-xs font-bold text-gray-400 uppercase mr-2" data-i18n="filter_label_type">Tipo:</span>
                                <button onclick="setFilter('type', 'all')" class="filter-type px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition active-filter" data-val="all" data-i18n="filter_all">Todos</button>
                                <button onclick="setFilter('type', 'core')" class="filter-type px-3 py-1 rounded-full text-sm bg-red-100 text-red-800 hover:bg-red-200 transition" data-val="core" data-i18n="filter_core">Separables</button>
                                <button onclick="setFilter('type', 'phrase')" class="filter-type px-3 py-1 rounded-full text-sm bg-yellow-100 text-yellow-800 hover:bg-yellow-200 transition" data-val="phrase" data-i18n="filter_phrase">Frases V+O</button>
                                <button onclick="setFilter('type', 'missing')" class="filter-type px-3 py-1 rounded-full text-sm bg-green-100 text-green-800 hover:bg-green-200 transition" data-val="missing" data-i18n="filter_added">A√±adidos</button>
                            </div>
                            <div class="flex flex-wrap gap-2 items-center">
                                <span class="text-xs font-bold text-gray-400 uppercase mr-2" data-i18n="filter_label_level">Nivel:</span>
                                <button onclick="setFilter('hsk', 'all')" class="filter-hsk px-2 py-1 rounded text-xs border border-gray-300 text-gray-600 hover:bg-white active-hsk bg-gray-800 text-white border-transparent" data-val="all">All</button>
                                <button onclick="setFilter('hsk', 'HSK1')" class="filter-hsk px-2 py-1 rounded text-xs border border-gray-300 text-gray-600 hover:bg-white" data-val="HSK1">HSK 1</button>
                                <button onclick="setFilter('hsk', 'HSK2')" class="filter-hsk px-2 py-1 rounded text-xs border border-gray-300 text-gray-600 hover:bg-white" data-val="HSK2">HSK 2</button>
                                <button onclick="setFilter('hsk', 'HSK3')" class="filter-hsk px-2 py-1 rounded text-xs border border-gray-300 text-gray-600 hover:bg-white" data-val="HSK3">HSK 3</button>
                                <button onclick="setFilter('hsk', 'HSK4')" class="filter-hsk px-2 py-1 rounded text-xs border border-gray-300 text-gray-600 hover:bg-white" data-val="HSK4">HSK 4+</button>
                            </div>
                        </div>

                        <!-- View Toggles Right -->
                        <div class="flex gap-4 border-l border-gray-300 pl-4">
                            <label class="flex items-center cursor-pointer">
                                <div class="relative">
                                    <input type="checkbox" id="toggle-pinyin" class="sr-only toggle-checkbox" checked onchange="toggleView('pinyin')">
                                    <div id="vis-pinyin-bg" class="block bg-green-400 w-10 h-6 rounded-full toggle-bg"></div>
                                    <div id="vis-pinyin-dot" class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full toggle-dot translate-x-full"></div>
                                </div>
                                <div class="ml-2 text-xs font-bold text-gray-600 uppercase">Pinyin</div>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <div class="relative">
                                    <input type="checkbox" id="toggle-mean" class="sr-only toggle-checkbox" checked onchange="toggleView('mean')">
                                    <div id="vis-mean-bg" class="block bg-green-400 w-10 h-6 rounded-full toggle-bg"></div>
                                    <div id="vis-mean-dot" class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full toggle-dot translate-x-full"></div>
                                </div>
                                <div class="ml-2 text-xs font-bold text-gray-600 uppercase" data-i18n="toggle_mean">Trad.</div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Cards Grid -->
                <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pt-2">
                    <!-- Javascript will populate this -->
                </div>
            </div>
        </section>

        <!-- LAB TAB -->
        <section id="view-lab" class="view-section bg-white py-10 md:py-16">
            <div class="container mx-auto px-4 max-w-5xl">
                <div class="bg-white rounded-xl shadow-lg border border-purple-100 overflow-hidden">
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 text-white">
                        <h3 class="text-2xl font-bold flex items-center">
                            <span class="text-3xl mr-3">üß™</span> <span data-i18n="lab_title">Laboratorio de Gram√°tica IA</span>
                        </h3>
                        <p class="text-purple-100 text-sm mt-1" data-i18n="lab_subtitle">Escribe una frase y la IA verificar√° si has separado correctamente el verbo.</p>
                    </div>
                    <div class="p-6 md:p-8 grid md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2" data-i18n="lab_input_label">Tu frase en chino:</label>
                                <textarea id="grammar-input" rows="4" class="w-full p-4 rounded-lg border border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition bg-gray-50" placeholder="e.g.: ÊàëÁù°Ëßâ‰∫Ü‰∏â‰∏™Â∞èÊó∂ ..."></textarea>
                            </div>
                            <button onclick="checkGrammar()" id="btn-check-grammar" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg shadow transition flex items-center justify-center space-x-2">
                                <span data-i18n="lab_button">Analizar Gram√°tica ‚ú®</span>
                            </button>
                        </div>
                        <div class="bg-stone-50 rounded-lg p-6 border border-stone-200 relative min-h-[200px]">
                            <h4 class="text-xs uppercase tracking-wide text-gray-500 font-bold mb-3" data-i18n="lab_result_title">Diagn√≥stico de la IA</h4>
                            <div id="grammar-result" class="text-gray-600 text-sm leading-relaxed">
                                <p class="italic text-gray-400" data-i18n="lab_placeholder">El resultado aparecer√° aqu√≠...</p>
                            </div>
                            <div id="grammar-loader" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center">
                                <div class="flex flex-col items-center">
                                    <div class="loader mb-2"></div>
                                    <span class="text-xs text-purple-600 font-bold" data-i18n="lab_loading">Analizando...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-gray-800 text-gray-400 py-6 text-center text-sm">
        <div class="container mx-auto">
            <p data-i18n="footer">Herramienta educativa para el aprendizaje de chino.</p>
            <p class="mt-2 text-xs opacity-50">Potenciado por Gemini API ‚ú®</p>
        </div>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        const translations = {
            es: {
                app_title: "Gu√≠a de Verbos Separables", app_subtitle: "Gram√°tica y Vocabulario HSK",
                nav_theory: "Teor√≠a", nav_vocab: "Vocabulario", nav_lab: "Laboratorio IA ‚ú®",
                modal_title: "Configuraci√≥n", modal_lang_label: "Idioma / Language", modal_desc: "Para usar las funciones de IA, necesitas una API Key.",
                modal_privacy: "Tu clave se guarda localmente en tu navegador.", modal_get_key: "Obtener clave gratis ‚Üó", modal_save: "Guardar",
                hero_tag: "GRAM√ÅTICA HSK", theory_title: "Gram√°tica de los Á¶ªÂêàËØç",
                theory_intro: "En chino, verbos como 'Dormir' (Áù°Ëßâ) no son una sola pieza. Son un <strong>'S√°ndwich'</strong> formado por una Acci√≥n (Verbo) y una Cosa (Objeto).",
                rule1_title: "Estructura S√°ndwich", rule1_desc: "Imagina que el verbo se abre para meter informaci√≥n dentro.",
                rule2_title: "Regla de Oro", rule2_desc: "No puedes a√±adir otro objeto al final, ¬°ya tiene uno!",
                rule3_title: "V+O vs Separable Puro", rule3_desc: "<strong>Comprar coche (‰π∞ËΩ¶)</strong> es literal.<br><strong>Nadar (Ê∏∏Ê≥≥)</strong> es abstracto.",
                gram_verb: "Verbo", gram_info: "Info", gram_obj: "Objeto", gram_you: "t√∫",
                btn_goto_vocab: "Ir al Vocabulario ‚ûú", vocab_title: "Biblioteca de Verbos", vocab_count_label: "palabras mostradas",
                filter_label_type: "Tipo:", filter_label_level: "Nivel:", filter_all: "Todos", filter_core: "Separables", filter_phrase: "Frases V+O", filter_added: "A√±adidos",
                toggle_mean: "Trad.", lab_title: "Laboratorio de Gram√°tica IA", lab_subtitle: "Escribe una frase y la IA verificar√° la estructura del verbo separable.",
                lab_input_label: "Tu frase en chino:", lab_button: "Analizar Gram√°tica ‚ú®", lab_result_title: "Diagn√≥stico de la IA",
                lab_placeholder: "El resultado aparecer√° aqu√≠...", lab_loading: "Analizando...", footer: "Herramienta educativa para el aprendizaje de chino.",
                tag_core: "Separable Puro", tag_phrase: "Frase V+O", tag_missing: "A√±adido", split_label: "Separaci√≥n:",
                gen_btn: "Generar Ejemplo Nuevo ‚ú®", gen_loading: "Generando...", card_hint: "üëá Toca para ver estructura",
                alert_key: "Por favor, introduce una clave v√°lida.", ai_error: "Error de conexi√≥n o clave.", prompt_lang_instruction: "in Spanish"
            },
            en: {
                app_title: "Separable Verbs Guide", app_subtitle: "HSK Grammar and Vocabulary",
                nav_theory: "Theory", nav_vocab: "Vocabulary", nav_lab: "AI Lab ‚ú®",
                modal_title: "Settings", modal_lang_label: "Language / Idioma", modal_desc: "To use AI features, you need an API Key.",
                modal_privacy: "Your key is stored locally in your browser.", modal_get_key: "Get free key ‚Üó", modal_save: "Save",
                hero_tag: "HSK GRAMMAR", theory_title: "Grammar of Á¶ªÂêàËØç",
                theory_intro: "In Chinese, verbs like 'Sleep' (Áù°Ëßâ) aren't one piece. They are a <strong>'Sandwich'</strong> made of an Action (Verb) and a Thing (Object).",
                rule1_title: "Sandwich Structure", rule1_desc: "Imagine the verb opening up to fit information inside.",
                rule2_title: "Golden Rule", rule2_desc: "You cannot place another object at the end, it already has one!",
                rule3_title: "VO vs Pure Separable", rule3_desc: "<strong>Buy car (‰π∞ËΩ¶)</strong> is literal.<br><strong>Swim (Ê∏∏Ê≥≥)</strong> is abstract.",
                gram_verb: "Verb", gram_info: "Info", gram_obj: "Object", gram_you: "you",
                btn_goto_vocab: "Go to Vocabulary ‚ûú", vocab_title: "Verb Library", vocab_count_label: "words shown",
                filter_label_type: "Type:", filter_label_level: "Level:", filter_all: "All", filter_core: "True Separable", filter_phrase: "VO Phrase", filter_added: "Added",
                toggle_mean: "Trans.", lab_title: "AI Grammar Lab", lab_subtitle: "Type a sentence and AI will verify the separable verb structure.",
                lab_input_label: "Your Chinese sentence:", lab_button: "Analyze Grammar ‚ú®", lab_result_title: "AI Diagnosis",
                lab_placeholder: "Result will appear here...", lab_loading: "Analyzing...", footer: "Educational tool for Chinese learning.",
                tag_core: "True Separable", tag_phrase: "VO Phrase", tag_missing: "Added", split_label: "Split:",
                gen_btn: "Generate New Example ‚ú®", gen_loading: "Generating...", card_hint: "üëá Tap to view structure",
                alert_key: "Please enter a valid key.", ai_error: "Connection or Key error.", prompt_lang_instruction: "in English"
            }
        };

        let currentLang = 'es';
        let userApiKey = "";
        let currentTab = 'theory';
        let filters = { type: 'all', hsk: 'all' };
        let viewState = { pinyin: true, mean: true };

        const verbs = [
            { id: 1, hanzi: "Ë∑ëÊ≠•", pinyin: "p«éo b√π", type: "core", level: "HSK2", mean: "Correr", mean_en: "Run / Jog", example: "Ë∑ë‰∫Ü‰∫åÂçÅÂàÜÈíüÊ≠•", ex_pin: "P«éo le √®rsh√≠ fƒìnzh≈çng b√π", ex_mean: "Corr√≠ durante 20 minutos", ex_mean_en: "Ran for 20 minutes" },
            { id: 2, hanzi: "Êï£Ê≠•", pinyin: "s√†n b√π", type: "core", level: "HSK4", mean: "Dar un paseo", mean_en: "Take a walk", example: "Êï£‰∫Ü‰∏Ä‰ºöÂÑøÊ≠•", ex_pin: "S√†n le yƒ´hu√¨r b√π", ex_mean: "Di un paseo por un rato", ex_mean_en: "Took a walk for a while" },
            { id: 3, hanzi: "Ê∏∏Ê≥≥", pinyin: "y√≥u y«íng", type: "core", level: "HSK2", mean: "Nadar", mean_en: "Swim", example: "Ê∏∏Ëøá‰∏ÄÊ¨°Ê≥≥", ex_pin: "Y√≥u gu√≤ yƒ´ c√¨ y«íng", ex_mean: "He nadado una vez", ex_mean_en: "Swam once" },
            { id: 4, hanzi: "Ë∏¢Ë∂≥ÁêÉ", pinyin: "tƒ´ z√∫qi√∫", type: "phrase", level: "HSK2", mean: "Jugar f√∫tbol", mean_en: "Play soccer", example: "Ë∏¢‰∫Ü‰∏ÄÂú∫Ë∂≥ÁêÉ", ex_pin: "Tƒ´ le yƒ´ ch«éng z√∫qi√∫", ex_mean: "Jugu√© un partido de f√∫tbol", ex_mean_en: "Played a soccer match" },
            { id: 5, hanzi: "ÊâìÁØÆÁêÉ", pinyin: "d«é l√°nqi√∫", type: "phrase", level: "HSK2", mean: "Jugar baloncesto", mean_en: "Play basketball", example: "ÊâìËøáÁØÆÁêÉÂêóÔºü", ex_pin: "D«é gu√≤ l√°nqi√∫ ma?", ex_mean: "¬øHas jugado baloncesto alguna vez?", ex_mean_en: "Have you played basketball?" },
            { id: 6, hanzi: "ÊâìÊ©ÑÊ¶ÑÁêÉ", pinyin: "d«é g«énl«énqi√∫", type: "phrase", level: "HSK5", mean: "Jugar rugby", mean_en: "Play rugby", example: "ÊâìÊâìÊ©ÑÊ¶ÑÁêÉ", ex_pin: "D«é d«é g«énl«énqi√∫", ex_mean: "Jugar un poco de rugby", ex_mean_en: "Play a bit of rugby" }, 
            { id: 7, hanzi: "ÊâìËΩ¶", pinyin: "d«é chƒì", type: "core", level: "HSK4", mean: "Tomar taxi", mean_en: "Take a taxi", example: "Êâì‰∏çÂà∞ËΩ¶", ex_pin: "D«é b√π d√†o chƒì", ex_mean: "No consigo taxi", ex_mean_en: "Cannot get a taxi" },
            { id: 8, hanzi: "È™ëËΩ¶", pinyin: "q√≠ chƒì", type: "phrase", level: "HSK2", mean: "Montar bici", mean_en: "Ride a bike", example: "È™ëÁùÄËΩ¶Âéª", ex_pin: "Q√≠ zhe chƒì q√π", ex_mean: "Ir en bicicleta", ex_mean_en: "Ride a bike there" },
            { id: 9, hanzi: "ÂÅúËΩ¶", pinyin: "t√≠ng chƒì", type: "phrase", level: "HSK4", mean: "Aparcar", mean_en: "Park a car", example: "ÂÅúÂ•ΩËΩ¶", ex_pin: "T√≠ng h«éo chƒì", ex_mean: "Aparcar bien el coche", ex_mean_en: "Parked the car well" },
            { id: 10, hanzi: "‰π∞ËΩ¶", pinyin: "m«éi chƒì", type: "phrase", level: "HSK1", mean: "Comprar coche", mean_en: "Buy a car", example: "‰π∞‰∫Ü‰∏âËæÜËΩ¶", ex_pin: "M«éi le sƒÅn li√†ng chƒì", ex_mean: "Compr√© tres coches", ex_mean_en: "Bought three cars" },
            { id: 11, hanzi: "Âî±Ê≠å", pinyin: "ch√†ng gƒì", type: "core", level: "HSK2", mean: "Cantar", mean_en: "Sing", example: "Âî±‰∏ÄÈ¶ñÊ≠å", ex_pin: "Ch√†ng yƒ´ sh«íu gƒì", ex_mean: "Cantar una canci√≥n", ex_mean_en: "Sing a song" },
            { id: 12, hanzi: "Ë∑≥Ëàû", pinyin: "ti√†o w«î", type: "core", level: "HSK2", mean: "Bailar", mean_en: "Dance", example: "Ë∑≥Ë∑≥Ëàû", ex_pin: "Ti√†o ti√†o w«î", ex_mean: "Bailar un poco", ex_mean_en: "Dance a bit" },
            { id: 13, hanzi: "Áúã‰π¶", pinyin: "k√†n sh≈´", type: "phrase", level: "HSK1", mean: "Leer", mean_en: "Read a book", example: "Áúã‰∫ÜÂçäÂ§©‰π¶", ex_pin: "K√†n le b√†ntiƒÅn sh≈´", ex_mean: "Le√≠ durante mucho rato", ex_mean_en: "Read for a long time" },
            { id: 14, hanzi: "ÁúãÁîµÂΩ±", pinyin: "k√†n di√†ny«êng", type: "phrase", level: "HSK1", mean: "Ver pel√≠cula", mean_en: "Watch movie", example: "Áúã‰∏ÄÂú∫ÁîµÂΩ±", ex_pin: "K√†n yƒ´ ch«éng di√†ny«êng", ex_mean: "Ver una pel√≠cula", ex_mean_en: "Watch a movie" },
            { id: 15, hanzi: "ÊãçÁÖß", pinyin: "pƒÅi zh√†o", type: "core", level: "HSK3", mean: "Tomar fotos", mean_en: "Take photos", example: "Êãç‰∏§Âº†ÁÖß", ex_pin: "PƒÅi li«éng zhƒÅng zh√†o", ex_mean: "Tomar dos fotos", ex_mean_en: "Take two photos" },
            { id: 16, hanzi: "Ëµ∑Â∫ä", pinyin: "q«ê chu√°ng", type: "core", level: "HSK2", mean: "Levantarse", mean_en: "Get up", example: "Ëµ∑ÂæóÊù•Â∫ä", ex_pin: "Q«ê de l√°i chu√°ng", ex_mean: "Poder levantarse de la cama", ex_mean_en: "Can get out of bed" },
            { id: 17, hanzi: "Âà∑Áâô", pinyin: "shuƒÅ y√°", type: "core", level: "HSK3", mean: "Cepillar dientes", mean_en: "Brush teeth", example: "Âà∑ÂÆåÁâô", ex_pin: "ShuƒÅ w√°n y√°", ex_mean: "Terminar de cepillarse", ex_mean_en: "Finish brushing teeth" },
            { id: 18, hanzi: "Ê¥óËÑ∏", pinyin: "x«ê li«én", type: "phrase", level: "HSK3", mean: "Lavar cara", mean_en: "Wash face", example: "Ê¥óÊ¥óËÑ∏", ex_pin: "X«ê xi li«én", ex_mean: "Lavarse la cara un poco", ex_mean_en: "Wash face a bit" },
            { id: 19, hanzi: "Ê¥óÊæ°", pinyin: "x«ê z«éo", type: "core", level: "HSK3", mean: "Ba√±arse", mean_en: "Take a bath", example: "Ê¥ó‰∫Ü‰∏Ä‰∏™ÁÉ≠Ê∞¥Êæ°", ex_pin: "X«ê le yƒ´ g√® r√®shu«ê z«éo", ex_mean: "Darse un ba√±o de agua caliente", ex_mean_en: "Took a hot bath" },
            { id: 20, hanzi: "Áù°Ëßâ", pinyin: "shu√¨ ji√†o", type: "core", level: "HSK1", mean: "Dormir", mean_en: "Sleep", example: "Áù°‰∏™Â•ΩËßâ", ex_pin: "Shu√¨ g√® h«éo ji√†o", ex_mean: "Dormir bien", ex_mean_en: "Have a good sleep" },
            { id: 21, hanzi: "ÂåñÂ¶Ü", pinyin: "hu√† zhuƒÅng", type: "core", level: "HSK4", mean: "Maquillarse", mean_en: "Put on makeup", example: "Âåñ‰∫ÜÊµìÂ¶Ü", ex_pin: "Hu√† le n√≥ng zhuƒÅng", ex_mean: "Maquillarse mucho", ex_mean_en: "Put on heavy makeup" },
            { id: 22, hanzi: "ÁîüÁóÖ", pinyin: "shƒìng b√¨ng", type: "core", level: "HSK2", mean: "Enfermarse", mean_en: "Get sick", example: "Áîü‰∫Ü‰∏ÄÂú∫Â§ßÁóÖ", ex_pin: "Shƒìng le yƒ´ ch«éng d√† b√¨ng", ex_mean: "Enfermarse gravemente", ex_mean_en: "Got seriously ill" },
            { id: 23, hanzi: "ËßÅÈù¢", pinyin: "ji√†n mi√†n", type: "missing", level: "HSK3", mean: "Verse / Encontrarse", mean_en: "Meet / See each other", example: "Ë∑üÊúãÂèãËßÅ‰∏™Èù¢", ex_pin: "Gƒìn p√©ngy«íu ji√†n g√® mi√†n", ex_mean: "Encontrarse con un amigo", ex_mean_en: "Meet with a friend" },
            { id: 24, hanzi: "Â∏ÆÂøô", pinyin: "bƒÅng m√°ng", type: "missing", level: "HSK3", mean: "Ayudar", mean_en: "Help / Do a favor", example: "Â∏Æ‰∫ÜÊàë‰∏Ä‰∏™Â§ßÂøô", ex_pin: "BƒÅng le w«í yƒ´ g√® d√† m√°ng", ex_mean: "Me hizo un gran favor", ex_mean_en: "Did me a big favor" },
            { id: 25, hanzi: "ËÅäÂ§©", pinyin: "li√°o tiƒÅn", type: "missing", level: "HSK3", mean: "Charlar", mean_en: "Chat", example: "ËÅä‰∫Ü‰∏Ä‰ºöÂÑøÂ§©", ex_pin: "Li√°o le yƒ´hu√¨r tiƒÅn", ex_mean: "Charlar un rato", ex_mean_en: "Chatted for a while" },
            { id: 26, hanzi: "ÁîüÊ∞î", pinyin: "shƒìng q√¨", type: "missing", level: "HSK3", mean: "Enfadarse", mean_en: "Get angry", example: "ÁîüËøáÊàëÁöÑÊ∞î", ex_pin: "Shƒìng gu√≤ w«í de q√¨", ex_mean: "Se ha enfadado conmigo", ex_mean_en: "Has been angry with me" },
            { id: 27, hanzi: "ÁªìÂ©ö", pinyin: "ji√© h≈´n", type: "missing", level: "HSK3", mean: "Casarse", mean_en: "Get married", example: "ÁªìËøá‰∏§Ê¨°Â©ö", ex_pin: "Ji√© gu√≤ li«éng c√¨ h≈´n", ex_mean: "Casarse dos veces", ex_mean_en: "Married twice" },
            { id: 28, hanzi: "ËØ∑ÂÅá", pinyin: "q«êng ji√†", type: "missing", level: "HSK3", mean: "Pedir permiso/libre", mean_en: "Ask for leave", example: "ËØ∑‰∏âÂ§©ÂÅá", ex_pin: "Q«êng sƒÅn tiƒÅn ji√†", ex_mean: "Pedir 3 d√≠as libres", ex_mean_en: "Ask for 3 days leave" },
            { id: 29, hanzi: "ËÄÉËØï", pinyin: "k«éo sh√¨", type: "missing", level: "HSK2", mean: "Examinarse", mean_en: "Take an exam", example: "ËÄÉÂÆåËØï‰∫Ü", ex_pin: "K«éo w√°n sh√¨ le", ex_mean: "Examen terminado", ex_mean_en: "Finished the exam" },
            { id: 30, hanzi: "ÊØï‰∏ö", pinyin: "b√¨ y√®", type: "missing", level: "HSK4", mean: "Graduarse", mean_en: "Graduate", example: "ÊØï‰∏ç‰∫Ü‰∏ö", ex_pin: "B√¨ b√π li«éo y√®", ex_mean: "No poder graduarse", ex_mean_en: "Cannot graduate" }
        ];

        function init() {
            const storedKey = localStorage.getItem('gemini_api_key');
            if (storedKey) { userApiKey = storedKey; document.getElementById('api-key-input').value = storedKey; updateStatusDot(true); }
            const storedLang = localStorage.getItem('app_lang');
            if (storedLang) { currentLang = storedLang; }
            
            syncToggles(); // FORCE VISUAL SYNC ON LOAD
            updateInterfaceLanguage();
            applyFilters();
        }

        // --- NEW SYNC FUNCTION ---
        function syncToggles() {
            // Forces the visual state (Green/Grey) to match the actual checkbox state on reload
            ['pinyin', 'mean'].forEach(field => {
                const checkbox = document.getElementById(`toggle-${field}`);
                const bg = document.getElementById(`vis-${field}-bg`);
                const dot = document.getElementById(`vis-${field}-dot`);
                
                // Update internal state to match browser's remembered state
                viewState[field] = checkbox.checked;

                if (checkbox.checked) {
                    bg.classList.add('bg-green-400');
                    bg.classList.remove('bg-gray-300');
                    dot.classList.add('translate-x-full');
                } else {
                    bg.classList.remove('bg-green-400');
                    bg.classList.add('bg-gray-300');
                    dot.classList.remove('translate-x-full');
                }
            });
        }

        function switchTab(tabId) {
            currentTab = tabId;
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabId}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tabId}`).classList.add('active');
            document.querySelectorAll('.mobile-nav-btn').forEach(el => el.classList.remove('text-red-700', 'font-bold'));
            document.getElementById(`mob-${tabId}`).classList.add('text-red-700', 'font-bold');
            window.scrollTo(0,0);
        }

        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('app_lang', lang);
            updateInterfaceLanguage();
            applyFilters(); 
        }

        function toggleView(field) {
            const checkbox = document.getElementById(`toggle-${field}`);
            viewState[field] = checkbox.checked;
            
            // Visual Updates
            const bg = document.getElementById(`vis-${field}-bg`);
            const dot = document.getElementById(`vis-${field}-dot`);
            
            if (checkbox.checked) {
                bg.classList.add('bg-green-400'); bg.classList.remove('bg-gray-300'); dot.classList.add('translate-x-full');
            } else {
                bg.classList.remove('bg-green-400'); bg.classList.add('bg-gray-300'); dot.classList.remove('translate-x-full');
            }

            // CSS Toggle for Content
            const elements = document.querySelectorAll(`.view-${field}`);
            elements.forEach(el => {
                if (checkbox.checked) el.classList.remove('hidden-content');
                else el.classList.add('hidden-content');
            });
        }

        function updateInterfaceLanguage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[currentLang][key]) { el.innerHTML = translations[currentLang][key]; }
            });
            document.getElementById('lang-btn-es').className = `flex-1 py-2 px-4 rounded border text-sm font-medium transition ${currentLang === 'es' ? 'bg-purple-600 text-white border-purple-600 shadow' : 'bg-white text-gray-600 hover:bg-gray-50'}`;
            document.getElementById('lang-btn-en').className = `flex-1 py-2 px-4 rounded border text-sm font-medium transition ${currentLang === 'en' ? 'bg-purple-600 text-white border-purple-600 shadow' : 'bg-white text-gray-600 hover:bg-gray-50'}`;
        }

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            const content = document.getElementById('modal-content');
            if (modal.classList.contains('open')) {
                modal.classList.remove('open'); content.classList.remove('scale-100'); content.classList.add('scale-95');
            } else {
                modal.classList.add('open'); content.classList.remove('scale-95'); content.classList.add('scale-100');
            }
        }

        function saveSettings() {
            const input = document.getElementById('api-key-input');
            const key = input.value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key); userApiKey = key; updateStatusDot(true); toggleSettings();
            } else { alert(translations[currentLang].alert_key); }
        }

        function updateStatusDot(isActive) {
            const dot = document.getElementById('key-status-dot');
            dot.className = `absolute top-2 right-2 w-2 h-2 rounded-full ring-2 ring-white ${isActive ? 'bg-green-500' : 'bg-red-500'}`;
        }

        function setFilter(category, value) {
            filters[category] = value;
            const buttons = document.querySelectorAll(category === 'type' ? '.filter-type' : '.filter-hsk');
            buttons.forEach(btn => {
                if (btn.dataset.val === value) {
                    if (category === 'type') btn.className = `filter-type px-3 py-1 rounded-full text-sm bg-gray-800 text-white shadow transition`;
                    else btn.className = `filter-hsk px-2 py-1 rounded text-xs border border-transparent bg-gray-800 text-white hover:bg-gray-700 active-hsk`;
                } else {
                    if (category === 'type') {
                        if (btn.dataset.val === 'core') btn.className = `filter-type px-3 py-1 rounded-full text-sm bg-red-100 text-red-800 hover:bg-red-200 transition`;
                        else if (btn.dataset.val === 'phrase') btn.className = `filter-type px-3 py-1 rounded-full text-sm bg-yellow-100 text-yellow-800 hover:bg-yellow-200 transition`;
                        else if (btn.dataset.val === 'missing') btn.className = `filter-type px-3 py-1 rounded-full text-sm bg-green-100 text-green-800 hover:bg-green-200 transition`;
                        else btn.className = `filter-type px-3 py-1 rounded-full text-sm bg-gray-200 text-gray-700 hover:bg-gray-300 transition`;
                    } else {
                        btn.className = `filter-hsk px-2 py-1 rounded text-xs border border-gray-300 text-gray-600 hover:bg-white`;
                    }
                }
            });
            applyFilters();
        }

        function applyFilters() {
            let filtered = verbs;
            if (filters.type !== 'all') filtered = filtered.filter(v => v.type === filters.type);
            if (filters.hsk !== 'all') {
                if (filters.hsk === 'HSK4') filtered = filtered.filter(v => parseInt(v.level.replace('HSK','')) >= 4);
                else filtered = filtered.filter(v => v.level === filters.hsk);
            }
            renderCards(filtered);
        }

        function renderCards(data) {
            const container = document.getElementById('cards-container');
            const countDisplay = document.getElementById('filtered-count');
            countDisplay.innerText = data.length;
            container.innerHTML = '';
            const t = translations[currentLang];

            data.forEach(verb => {
                let tagColor, tagText, borderClass;
                if (verb.type === 'core') { tagColor = "bg-red-50 text-red-700"; tagText = t.tag_core; borderClass = "border-l-4 border-red-500"; }
                else if (verb.type === 'phrase') { tagColor = "bg-yellow-50 text-yellow-700"; tagText = t.tag_phrase; borderClass = "border-l-4 border-yellow-500"; }
                else if (verb.type === 'missing') { tagColor = "bg-green-50 text-green-700 font-bold"; tagText = t.tag_missing; borderClass = "border-l-4 border-green-500"; }

                const displayMean = currentLang === 'en' && verb.mean_en ? verb.mean_en : verb.mean;
                const char1 = verb.hanzi.charAt(0);
                const charRest = verb.hanzi.slice(1);
                
                // Example Logic
                const exPin = verb.ex_pin || "";
                const exMean = currentLang === 'en' ? (verb.ex_mean_en || "") : (verb.ex_mean || "");
                
                // Visibility Logic
                const pinyinHidden = viewState.pinyin ? '' : 'hidden-content';
                const meanHidden = viewState.mean ? '' : 'hidden-content';

                const card = document.createElement('div');
                card.className = `bg-white rounded-lg shadow-sm p-5 card ${borderClass} cursor-pointer hover:bg-stone-50 relative group`;
                card.onclick = (e) => { if(e.target.closest('.ai-interaction')) return; toggleExpand(card); };
                
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-baseline space-x-2">
                                <h3 class="hanzi-lg text-gray-800">${verb.hanzi}</h3>
                                <span class="pinyin font-serif view-pinyin ${pinyinHidden}">${verb.pinyin}</span>
                            </div>
                            <p class="text-sm text-gray-500 mt-1 view-mean ${meanHidden}">${displayMean}</p>
                        </div>
                        <div class="flex flex-col items-end space-y-1">
                            <span class="text-[10px] uppercase tracking-wider px-2 py-1 rounded bg-stone-100 text-stone-500 font-bold">${verb.level}</span>
                            <span class="text-[10px] uppercase tracking-wider px-2 py-1 rounded ${tagColor}">${tagText}</span>
                        </div>
                    </div>
                    
                    <div class="expand-content mt-4 border-t border-dashed border-gray-200 pt-3">
                        <div class="text-sm text-gray-600 mb-2 font-semibold flex justify-between">
                            <span>${t.split_label}</span>
                        </div>
                        <div class="bg-gray-100 p-3 rounded text-center">
                            <span class="text-lg font-bold text-gray-800">${char1}</span>
                            <span class="text-red-600 mx-1 text-sm italic">...</span>
                            <span class="text-lg font-bold text-gray-800">${charRest}</span>
                        </div>
                        <div class="mt-3 text-center">
                             <p class="text-sm text-gray-800 italic font-medium">"${verb.example}"</p>
                             <p class="text-xs text-gray-500 mt-1 font-serif view-pinyin ${pinyinHidden}">${exPin}</p>
                             <p class="text-xs text-purple-700 mt-1 view-mean ${meanHidden}">${exMean}</p>
                        </div>
                        
                        <div class="mt-4 pt-3 border-t border-gray-100 ai-interaction">
                            <button onclick="generateExample('${verb.hanzi}', '${displayMean}', this)" class="w-full text-xs font-bold text-purple-600 bg-purple-50 hover:bg-purple-100 py-2 rounded transition flex items-center justify-center">
                                <span>${t.gen_btn}</span>
                            </button>
                            <div class="ai-result mt-2 text-xs text-gray-600 bg-white p-2 rounded border border-purple-100 hidden"></div>
                        </div>
                    </div>
                    <div class="text-center mt-2 text-gray-300 text-xs message-hint group-hover:text-red-400 transition-colors">${t.card_hint}</div>
                `;
                container.appendChild(card);
            });
        }

        function toggleExpand(cardElement) {
            const content = cardElement.querySelector('.expand-content');
            const hint = cardElement.querySelector('.message-hint');
            const isExpanded = content.classList.contains('active');
            document.querySelectorAll('.expand-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.message-hint').forEach(el => el.style.opacity = '1');
            if (!isExpanded) { content.classList.add('active'); hint.style.opacity = '0'; }
        }

        // --- AI ---
        async function callGemini(prompt) {
            if (!userApiKey) { toggleSettings(); return null; }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userApiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error();
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) { return null; }
        }

        async function generateExample(word, meaning, btn) {
            const t = translations[currentLang];
            const resultDiv = btn.nextElementSibling;
            const originalText = btn.innerHTML;
            if (!userApiKey) { toggleSettings(); return; }
            btn.innerHTML = `<span class="loader" style="width:12px; height:12px; border-width:2px;"></span> ${t.gen_loading}`; btn.disabled = true; resultDiv.classList.add('hidden');
            const langInstr = t.prompt_lang_instruction;
            const prompt = `Generate a short Chinese sentence (HSK3 level) using the separable verb "${word}" (${meaning}). IMPORTANT: You MUST split the verb (A-le-B, A-zhe-B, etc). Return ONLY JSON: {"hanzi": "sentence", "pinyin": "pinyin", "translation": "translation ${langInstr}"}`;
            const text = await callGemini(prompt);
            if (text) {
                try {
                    const jsonStr = text.replace(/```json|```/g, '').trim();
                    const data = JSON.parse(jsonStr);
                    resultDiv.innerHTML = `<div class="font-bold text-gray-800 mb-1">${data.hanzi}</div><div class="text-gray-500 mb-1 font-serif italic view-pinyin ${viewState.pinyin ? '' : 'hidden-content'}">${data.pinyin}</div><div class="text-purple-700 view-mean ${viewState.mean ? '' : 'hidden-content'}">${data.translation}</div>`; resultDiv.classList.remove('hidden');
                } catch (e) { resultDiv.innerHTML = "AI Parse Error"; resultDiv.classList.remove('hidden'); }
            } else { resultDiv.innerHTML = t.ai_error; resultDiv.classList.remove('hidden'); }
            btn.innerHTML = originalText; btn.disabled = false;
        }

        async function checkGrammar() {
            const input = document.getElementById('grammar-input').value;
            if (!input.trim()) return;
            if (!userApiKey) { toggleSettings(); return; }
            const loader = document.getElementById('grammar-loader'); const resultArea = document.getElementById('grammar-result');
            loader.classList.remove('hidden'); resultArea.innerHTML = "";
            const t = translations[currentLang];
            const prompt = `Act as a Chinese grammar teacher. Analyze this sentence: "${input}". Focus on Separable Verbs (Liheci). Output format: 1. Verdict: ‚úÖ or ‚ùå 2. Explanation: (${t.prompt_lang_instruction}, explain why). 3. Correction: (If incorrect, corrected Chinese + Pinyin).`;
            const text = await callGemini(prompt);
            loader.classList.add('hidden');
            if (text) { resultArea.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'); }
            else { resultArea.innerHTML = `<span class='text-red-500'>${t.ai_error}</span>`; }
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
